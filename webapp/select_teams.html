<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–û–±—Ä–∞—Ç–∏ –¥–≤—ñ –∫–æ–º–∞–Ω–¥–∏ ‚Äî Survivor Football</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;800&family=Russo+One&display=swap" rel="stylesheet" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --pitch: #0a1628;
      --ocean-deep: #0f1e35;
      --ocean-dark: #152640;
      --gold: #ffb84d;
      --gold-light: #ffd699;
      --accent: #ff6b6b;
      --success: #4ecdc4;
      --card-bg: rgba(21, 38, 64, 0.9);
      --card-border: rgba(78, 205, 196, 0.3);
      --tg-theme-bg-color: var(--pitch);
      --tg-theme-text-color: #e0e8f0;
      --squid: #6b46c1;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--pitch);
      background-image: 
        radial-gradient(ellipse at 50% 0%, rgba(78, 205, 196, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 20% 80%, rgba(107, 70, 193, 0.08) 0%, transparent 50%),
        linear-gradient(180deg, var(--ocean-dark) 0%, var(--pitch) 100%);
      color: var(--tg-theme-text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container { max-width: 420px; margin: 0 auto; padding: 20px 16px; }
    .header {
      text-align: center;
      padding: 20px 0 24px;
      border-bottom: 1px solid var(--card-border);
    }
    .header h1 { font-family: 'Russo One', sans-serif; font-size: 1.6rem; margin: 0; color: var(--gold); letter-spacing: 0.05em; text-shadow: 0 2px 8px rgba(255, 184, 77, 0.3); }
    .header h1::before { content: 'üè¥‚Äç‚ò†Ô∏è '; }
    .round-badge {
      display: inline-block;
      font-size: 0.85rem;
      margin-top: 10px;
      padding: 8px 14px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      color: var(--gold-light);
    }
    .intro {
      text-align: center;
      padding: 12px 0 16px;
      font-size: 0.95rem;
      line-height: 1.4;
      opacity: 0.95;
    }
    .content { padding: 8px 0 20px; }
    .loading { text-align: center; padding: 40px 20px; opacity: 0.9; }
    .error { color: var(--accent); padding: 16px; text-align: center; background: rgba(201,48,44,0.15); border-radius: 12px; margin-bottom: 16px; border: 1px solid rgba(201,48,44,0.3); }
    .info { color: var(--gold-light); padding: 16px; text-align: center; line-height: 1.5; }
    .team-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      margin-bottom: 8px;
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .team-row:active { opacity: 0.95; }
    .team-row.selected {
      background: rgba(78, 205, 196, 0.25);
      border-color: var(--success);
      box-shadow: 0 0 16px rgba(78, 205, 196, 0.4), 0 2px 8px rgba(0,0,0,0.2);
      transform: scale(1.02);
    }
    .team-row .check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .team-row.selected .check { background: var(--success); border-color: var(--success); color: #fff; }
    .team-row.used { background: rgba(255, 107, 107, 0.15); border-color: rgba(255, 107, 107, 0.4); cursor: not-allowed; opacity: 0.7; }
    .team-row.used .name { opacity: 0.9; }
    .team-row .name { flex: 1; font-size: 1rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .match-row {
      display: flex;
      align-items: center;
      flex-wrap: nowrap;
      gap: 8px;
      padding: 14px 18px;
      margin-bottom: 8px;
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .match-row .vs { opacity: 0.9; font-weight: 600; font-size: 1.1rem; flex-shrink: 0; }
    .team-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s, transform 0.1s;
      border: 2px solid transparent;
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    .team-btn span:not(.check) { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .team-btn .check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; }
    .team-btn.selected { background: rgba(78, 205, 196, 0.25); border-color: var(--success); box-shadow: 0 0 12px rgba(78, 205, 196, 0.4), 0 2px 6px rgba(0,0,0,0.15); transform: scale(1.05); }
    .team-btn.selected .check { background: var(--success); border-color: var(--success); color: #fff; }
    .team-btn.used { opacity: 0.7; cursor: not-allowed; }
    .team-btn:active:not(.used) { opacity: 0.95; transform: scale(0.98); }
    .counter { font-size: 0.85rem; opacity: 0.8; margin-bottom: 12px; text-align: center; }
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 16px 20px;
      font-size: 1.05rem;
      font-weight: 600;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-success { background: var(--success); color: #0a1628; font-weight: 600; box-shadow: 0 4px 16px rgba(78,205,196,0.4), 0 0 1px rgba(78,205,196,0.2); }
    .btn-primary { background: var(--accent); color: #fff; font-weight: 600; box-shadow: 0 4px 16px rgba(255,107,107,0.4), 0 0 1px rgba(255,107,107,0.2); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .success-screen { text-align: center; padding: 32px 20px; }
    .success-screen .icon { font-size: 3rem; margin-bottom: 16px; }
    .success-screen h2 { font-size: 1.25rem; margin: 0 0 12px; }
    .success-screen .chosen { font-size: 1.1rem; margin: 16px 0; line-height: 1.6; }
    .success-screen .wait { color: var(--success); font-weight: 500; margin-top: 24px; }
    .countdown-screen { text-align: center; padding: 32px 20px; }
    .countdown-screen .big-num { font-size: 4rem; font-weight: 700; color: var(--accent); line-height: 1.2; margin: 16px 0; }
    .countdown-screen .hint { font-size: 0.95rem; opacity: 0.9; margin-top: 12px; }
    .results-screen { padding: 20px 0; }
    .results-screen .icon { font-size: 3rem; margin-bottom: 12px; text-align: center; }
    .results-screen h2 { font-size: 1.25rem; margin: 0 0 16px; text-align: center; }
    .results-screen .message { text-align: center; margin-bottom: 20px; font-size: 1.05rem; line-height: 1.5; }
    .results-screen .message.passed { color: var(--success); }
    .results-screen .message.out { color: var(--accent); }
    .match-score { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; margin-bottom: 8px; background: var(--card-bg); border-radius: 10px; font-size: 0.95rem; }
    .match-score .score { font-weight: 600; margin: 0 8px; }
    .btn-next { margin-top: 20px; background: var(--success); color: #fff; }
    .btn-row { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .btn-row .btn { margin-top: 0; }
    .btn-outline { background: transparent; border: 2px solid var(--success); color: var(--success); }
    .win-screen { text-align: center; padding: 28px 20px; }
    .win-screen .icon { font-size: 3rem; margin-bottom: 12px; }
    .win-screen h2 { font-size: 1.25rem; margin: 0 0 8px; }
    .win-screen .amount { font-family: 'Russo One', sans-serif; font-size: 1.8rem; color: var(--gold); margin: 16px 0; text-shadow: 0 2px 12px rgba(255, 184, 77, 0.4); }
    .stake-line { font-size: 0.95rem; color: var(--gold); font-weight: 600; margin-top: 8px; }
    .stake-line .muted { font-weight: normal; opacity: 0.85; font-size: 0.85rem; }
    .ticket-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
    .ticket-card {
      display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;
      padding: 14px 18px; background: var(--card-bg); border: 2px solid var(--card-border); border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .ticket-card .ticket-teams { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%; }
    .ticket-card.out { opacity: 0.7; border-color: rgba(201,48,44,0.5); }
    .ticket-card .ticket-title { font-weight: 600; color: var(--gold-light); }
    .ticket-card .ticket-teams { font-size: 0.95rem; opacity: 0.95; }
    .ticket-card .btn-pick { padding: 8px 14px; font-size: 0.9rem; background: var(--success); color: #fff; border: none; border-radius: 10px; cursor: pointer; }
    .ticket-card .btn-pick:disabled { opacity: 0.6; cursor: not-allowed; }
    .run-round-wrap { margin-top: 20px; }
    .match-score-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; padding: 12px 16px; margin-bottom: 8px; background: var(--card-bg); border-radius: 12px; font-size: 0.95rem; }
    .match-score-grid .home, .match-score-grid .away { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 40%; }
    .match-score-grid .home { text-align: right; }
    .match-score-grid .away { text-align: left; }
    .match-score-grid .score { font-weight: 700; min-width: 3.5em; text-align: center; font-variant-numeric: tabular-nums; }
    .ticket-result { padding: 12px 16px; margin-bottom: 10px; border-radius: 12px; border: 1px solid var(--card-border); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .ticket-result.passed { background: rgba(78,205,196,0.2); border-color: var(--success); box-shadow: 0 2px 12px rgba(78,205,196,0.3); }
    .ticket-result.failed { background: rgba(255,107,107,0.15); border-color: rgba(255,107,107,0.4); box-shadow: 0 2px 12px rgba(255,107,107,0.2); }
    .ticket-result .team-not-scored { color: var(--accent); font-size: 0.9rem; margin-top: 6px; }
    .ticket-result .stake-after { font-size: 0.85rem; opacity: 0.9; }
    .section-label { font-size: 0.85rem; font-weight: 600; color: var(--gold-light); margin: 16px 0 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>–í—ã–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã</h1>
      <div class="round-badge" id="roundInfo">–¢—É—Ä ‚Äî</div>
      <p class="stake-line" id="stakeLine" style="display:none;">–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: <span id="stakeValue">‚Äî</span> –ø. <span class="muted">(√ó1.5 –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ç—É—Ä–∞)</span></p>
    </header>

    <p class="intro" id="intro">–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∏–ª–µ—Ç–∞ –ø–æ –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–±—å—é—Ç. –í —Å–ª–µ–¥—É—é—â–∏—Ö —Ç—É—Ä–∞—Ö –¥–ª—è —ç—Ç–æ–≥–æ –±–∏–ª–µ—Ç–∞ –Ω–µ–ª—å–∑—è –≤—ã–±–∏—Ä–∞—Ç—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.</p>

    <div id="content" class="content">
      <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</p>
    </div>

    <p class="counter" id="counter" style="display:none;">–í—ã–±—Ä–∞–Ω–æ: 0 –∏–∑ 2</p>
    <button type="button" id="submitBtn" class="btn btn-success" disabled style="display:none;">
      –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä
    </button>
    <div id="runRoundWrap" style="display:none;" class="run-round-wrap">
      <button type="button" id="btnRunRound" class="btn btn-primary">–ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—É—Ä–∞</button>
    </div>
  </div>

  <script>
(function () {
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const urlParams = new URLSearchParams(window.location.search);
  const entryId = urlParams.get('entry_id');
  const baseUrl = window.location.origin;

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  if (!entryId) {
    document.getElementById('content').innerHTML =
      '<p class="info">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –±–æ—Ç–∞ ‚Äî —Ç–∞–º –±—É–¥—É—Ç –≤–∞—à–∏ –∑–∞–ø–∏—Å–∏ –∏ –∫–Ω–æ–ø–∫–∞ ¬´–í—ã–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã¬ª.</p>' +
      '<p class="info">–ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç, –∞–¥–º–∏–Ω –¥–æ–±–∞–≤–∏—Ç –≤–∞—Å –≤ –∏–≥—Ä—É.</p>';
    document.getElementById('roundInfo').style.display = 'none';
    document.getElementById('intro').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
    return;
  }

  const roundEl = document.getElementById('roundInfo');
  const stakeLineEl = document.getElementById('stakeLine');
  const stakeValueEl = document.getElementById('stakeValue');
  const introEl = document.getElementById('intro');
  const contentEl = document.getElementById('content');
  const counterEl = document.getElementById('counter');
  const submitBtn = document.getElementById('submitBtn');

  function formatStake(n) {
    if (n == null || n === undefined) return '‚Äî';
    const x = Number(n);
    return x % 1 === 0 ? String(x) : x.toFixed(1);
  }

  let roundData = null;
  let currentTicketIndex = null;
  let teamsData = [];
  let selectedIds = [];

  async function loadTeamsForRound() {
    const r = await fetch(baseUrl + '/api/entry/' + entryId + '/teams_for_round');
    if (!r.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥');
    return r.json();
  }

  function toggleTeamSelection(teamId, usedSet) {
    if (usedSet.has(teamId)) return;
    const idx = selectedIds.indexOf(teamId);
    if (idx >= 0) selectedIds.splice(idx, 1);
    else if (selectedIds.length < 2) selectedIds.push(teamId);
    updateSelectionUI(usedSet);
  }

  function updateSelectionUI(usedSet) {
    document.querySelectorAll('.team-btn.selected, .team-row.selected').forEach(function (el) { el.classList.remove('selected'); });
    document.querySelectorAll('.team-btn .check, .team-row .check').forEach(function (el) { el.textContent = ''; });
    selectedIds.forEach(function (id) {
      const btn = document.querySelector('.team-btn[data-team-id="' + id + '"]');
      const row = document.querySelector('.team-row[data-team-id="' + id + '"]');
      if (btn) { btn.classList.add('selected'); var c = btn.querySelector('.check'); if (c) c.textContent = '‚úì'; }
      if (row) { row.classList.add('selected'); var c = row.querySelector('.check'); if (c) c.textContent = '‚úì'; }
    });
    counterEl.textContent = '–í—ã–±—Ä–∞–Ω–æ: ' + selectedIds.length + ' –∏–∑ 2';
    submitBtn.disabled = selectedIds.length !== 2;
  }

  function startPickForTicket(ticketIndex) {
    currentTicketIndex = ticketIndex;
    renderMain(roundData);
  }

  function renderMain(data) {
    if (!data) return;
    roundData = data;
    var rawTickets = data.tickets || [];
    var tickets = rawTickets.length > 0 ? rawTickets : [{ ticket_index: 1, status: 'active', stake_amount: data.stake || 10, used_team_ids: data.used_team_ids || [], selection: null }];
    const matches = data.matches || [];
    teamsData = data.teams || [];
    roundEl.textContent = '–¢—É—Ä ' + data.round;
    roundEl.style.display = 'inline-block';
    if (data.stake != null) {
      stakeValueEl.textContent = formatStake(data.stake);
      stakeLineEl.style.display = 'block';
    } else { stakeLineEl.style.display = 'none'; }

    if (teamsData.length === 0 && matches.length === 0) {
      contentEl.innerHTML = '<p class="info">–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç—É—Ä–∞ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∑–∂–µ.</p>';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      document.getElementById('runRoundWrap').style.display = 'none';
      return;
    }

    const hasAnySelection = tickets.some(function (t) { return t.selection; });
    const runRoundWrap = document.getElementById('runRoundWrap');
    if (runRoundWrap) runRoundWrap.style.display = hasAnySelection ? 'block' : 'none';

    if (currentTicketIndex != null) {
      const ticket = tickets.find(function (t) { return t.ticket_index === currentTicketIndex; });
      const usedSet = ticket ? new Set((ticket.used_team_ids || []).map(Number)) : new Set();
      selectedIds = [];
      introEl.style.display = 'none';
      let html = '<p class="info" style="margin-bottom:12px;">–ë–∏–ª–µ—Ç ' + currentTicketIndex + ' ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã:</p>';
      if (matches.length > 0) {
        html += matches.map(function (m) {
          var homeUsed = usedSet.has(m.home_id), awayUsed = usedSet.has(m.away_id);
          return '<div class="match-row">' +
            '<span class="team-btn' + (homeUsed ? ' used' : '') + '" data-team-id="' + m.home_id + '" data-used="' + (homeUsed ? '1' : '0') + '" role="button" tabindex="0">' +
              '<span class="check"></span><span>' + escapeHtml(m.home_name) + (homeUsed ? ' (–∏—Å–ø.)' : '') + '</span></span>' +
            ' <span class="vs">‚öîÔ∏è</span> ' +
            '<span class="team-btn' + (awayUsed ? ' used' : '') + '" data-team-id="' + m.away_id + '" data-used="' + (awayUsed ? '1' : '0') + '" role="button" tabindex="0">' +
              '<span class="check"></span><span>' + escapeHtml(m.away_name) + (awayUsed ? ' (–∏—Å–ø.)' : '') + '</span></span>' +
          '</div>';
        }).join('');
      } else {
        html += teamsData.map(function (t) {
          var used = usedSet.has(t.id);
          return '<div class="team-row' + (used ? ' used' : '') + '" data-team-id="' + t.id + '" data-used="' + (used ? '1' : '0') + '" role="button" tabindex="0">' +
            '<span class="check"></span><span class="name">' + escapeHtml(t.name) + (used ? ' (–∏—Å–ø.)' : '') + '</span></div>';
        }).join('');
      }
      contentEl.innerHTML = html;
      counterEl.style.display = 'block';
      counterEl.textContent = '–í—ã–±—Ä–∞–Ω–æ: 0 –∏–∑ 2';
      submitBtn.style.display = 'block';
      submitBtn.disabled = true;
      contentEl.querySelectorAll('.team-btn').forEach(function (btn) {
        btn.addEventListener('click', function (e) { e.preventDefault(); toggleTeamSelection(parseInt(btn.dataset.teamId, 10), usedSet); });
      });
      contentEl.querySelectorAll('.team-row').forEach(function (row) {
        row.addEventListener('click', function () {
          if (row.dataset.used === '1') return;
          toggleTeamSelection(parseInt(row.dataset.teamId, 10), usedSet);
        });
      });
      return;
    }

      selectedIds = [];
      introEl.style.display = 'block';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      let html = '';
      if (tickets.length > 0) {
        html += '<div class="ticket-cards">';
        tickets.forEach(function (t) {
          var out = t.status !== 'active';
          var sel = t.selection;
          html += '<div class="ticket-card' + (out ? ' out' : '') + '">';
          html += '<div><span class="ticket-title">üé´ –ë–∏–ª–µ—Ç ' + t.ticket_index + '</span> ¬∑ ' + formatStake(t.stake_amount) + ' –ø.</div>';
          if (out) {
            html += '<span class="ticket-teams">–í—ã–±—ã–ª</span>';
          } else if (sel) {
            html += '<span class="ticket-teams">' + escapeHtml(sel.team1_name) + ', ' + escapeHtml(sel.team2_name) + '</span>';
            html += '<button type="button" class="btn-pick" data-ticket="' + t.ticket_index + '">–ò–∑–º–µ–Ω–∏—Ç—å</button>';
          } else {
            html += '<button type="button" class="btn-pick" data-ticket="' + t.ticket_index + '">–í—ã–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã</button>';
          }
          html += '</div>';
        });
        html += '</div>';
      }
      if (matches.length > 0) {
        html += '<p class="info" style="margin-bottom:8px;">–ù–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã¬ª –¥–ª—è –±–∏–ª–µ—Ç–∞, –∑–∞—Ç–µ–º –≤—ã–±–µ—Ä–∏—Ç–µ –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ –º–∞—Ç—á–µ–π –Ω–∏–∂–µ.</p>';
        html += matches.map(function (m) {
          return '<div class="match-row">' +
            '<span class="team-btn" data-team-id="' + m.home_id + '" data-used="0" role="button" tabindex="0"><span class="check"></span><span>' + escapeHtml(m.home_name) + '</span></span>' +
            ' <span class="vs">‚öîÔ∏è</span> ' +
            '<span class="team-btn" data-team-id="' + m.away_id + '" data-used="0" role="button" tabindex="0"><span class="check"></span><span>' + escapeHtml(m.away_name) + '</span></span>' +
          '</div>';
        }).join('');
    } else {
      html += teamsData.map(function (t) {
        return '<div class="team-row" data-team-id="' + t.id + '" data-used="0" role="button" tabindex="0"><span class="check"></span><span class="name">' + escapeHtml(t.name) + '</span></div>';
      }).join('');
    }
    contentEl.innerHTML = html;
    contentEl.querySelectorAll('.btn-pick[data-ticket]').forEach(function (btn) {
      btn.addEventListener('click', function () { startPickForTicket(parseInt(btn.dataset.ticket, 10)); });
    });
  }

  function renderTeamList(data) {
    currentTicketIndex = null;
    renderMain(data);
  }

  function startCountdownThenRunRound() {
    const countdownEl = contentEl.querySelector('.success-screen');
    if (!countdownEl) return;
    const waitEl = countdownEl.querySelector('.wait');
    let sec = 10;
    function tick() {
      if (sec > 0) {
        waitEl.textContent = sec + '‚Ä¶ –°–∫–æ—Ä–æ –±—É–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.';
        sec--;
        setTimeout(tick, 1000);
        return;
      }
      waitEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤‚Ä¶';
      fetch(baseUrl + '/api/entry/' + entryId + '/run_round', { method: 'POST' })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          showResultsScreen(data);
        })
        .catch(function () {
          if (tg) tg.showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã');
          else alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã');
          if (waitEl) waitEl.textContent = '–û—à–∏–±–∫–∞. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
        });
    }
    tick();
  }

  function onRunRoundClick() {
    var wrap = document.getElementById('runRoundWrap');
    if (wrap) wrap.style.display = 'none';
    contentEl.innerHTML =
      '<div class="success-screen">' +
        '<div class="icon">‚è≥</div>' +
        '<h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—É—Ä–∞</h2>' +
        '<p class="wait">10‚Ä¶ –°–∫–æ—Ä–æ –±—É–¥—É—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.</p>' +
      '</div>';
    startCountdownThenRunRound();
  }

  function goToMainMenu() {
    window.location.href = baseUrl + '/';
  }

  function showResultsScreen(data) {
    const passed = data.passed === true;
    const tickets = data.tickets || [];
    let html = '<div class="results-screen">';
    html += '<div class="icon">' + (passed ? '‚úÖ' : '‚ùå') + '</div>';
    html += '<h2>' + (passed ? '–ü—Ä–æ—Ö–æ–¥–∏—Ç–µ –¥–∞–ª—å—à–µ!' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç—É—Ä–∞') + '</h2>';
    html += '<p class="message ' + (passed ? 'passed' : 'out') + '">' + escapeHtml(data.message || '') + '</p>';
    if (data.stake_after_round != null) {
      html += '<p class="stake-line">–°—É–º–º–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤: <strong>' + formatStake(data.stake_after_round) + '</strong> –ø–æ–∏–Ω—Ç–æ–≤</p>';
    }
    if (tickets.length > 0) {
      html += '<p class="section-label">–í–∞—à–∏ –±–∏–ª–µ—Ç—ã</p>';
      tickets.forEach(function (t) {
        html += '<div class="ticket-result ' + (t.passed ? 'passed' : 'failed') + '">';
        html += '<strong>–ë–∏–ª–µ—Ç ' + t.ticket_index + '</strong>: ' + escapeHtml(t.team1_name) + ', ' + escapeHtml(t.team2_name);
        html += ' ‚öîÔ∏è ' + (t.passed ? '‚úì –æ–±–µ –∑–∞–±–∏–ª–∏' : '‚úó –Ω–µ –∑–∞–±–∏–ª–∏');
        if (!t.passed && t.team_not_scored) {
          html += '<div class="team-not-scored">–ù–µ –∑–∞–±–∏–ª–∞: ' + escapeHtml(t.team_not_scored) + '</div>';
        }
        html += ' <span class="stake-after">' + formatStake(t.stake_after) + ' –ø.</span>';
        html += '</div>';
      });
    }
    if (data.matches && data.matches.length) {
      html += '<p class="section-label">–°—á–µ—Ç—ã –º–∞—Ç—á–µ–π</p>';
      data.matches.forEach(function (m) {
        html += '<div class="match-score-grid">' +
          '<span class="home">' + escapeHtml(m.home_name) + '</span>' +
          '<span class="score">' + m.home_goals + ' : ' + m.away_goals + '</span>' +
          '<span class="away">' + escapeHtml(m.away_name) + '</span>' +
        '</div>';
      });
    }
    if (passed) {
      html += '<div class="btn-row">';
      html += '<button type="button" class="btn btn-success" id="btnNextRound">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∞–ª—å—à–µ</button>';
      html += '<button type="button" class="btn btn-outline" id="btnCashOut">–ó–∞–±—Ä–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à</button>';
      html += '</div>';
    } else {
      html += '<button type="button" class="btn btn-success btn-next" id="btnMainMenuOut">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>';
    }
    html += '</div>';
    contentEl.innerHTML = html;
    const btnNext = document.getElementById('btnNextRound');
    if (btnNext) {
      btnNext.addEventListener('click', function () {
        window.location.reload();
      });
    }
    const btnCashOut = document.getElementById('btnCashOut');
    if (btnCashOut) {
      btnCashOut.addEventListener('click', function () {
        btnCashOut.disabled = true;
        fetch(baseUrl + '/api/entry/' + entryId + '/cash_out', { method: 'POST' })
          .then(function (r) { return r.json(); })
          .then(function (res) {
            const amount = res.amount != null ? formatStake(res.amount) : '0';
            const balanceStr = res.balance != null ? '<p class="stake-line">–í–∞—à –±–∞–ª–∞–Ω—Å —Ç–µ–ø–µ—Ä: <strong>' + res.balance + '</strong> –ø–æ—ñ–Ω—Ç—ñ–≤</p>' : '';
            contentEl.innerHTML =
              '<div class="results-screen win-screen">' +
                '<div class="icon">üèÜ</div>' +
                '<h2>–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏!</h2>' +
                '<p class="amount">' + amount + ' –ø–æ–∏–Ω—Ç–æ–≤</p>' +
                balanceStr +
                '<p class="message passed">–í—ã –∑–∞–±—Ä–∞–ª–∏ –≤—ã–∏–≥—Ä—ã—à. –°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É!</p>' +
                '<button type="button" class="btn btn-success btn-next" id="btnMainMenuWin">–í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>' +
              '</div>';
            document.getElementById('btnMainMenuWin').addEventListener('click', goToMainMenu);
          })
          .catch(function () {
            if (tg) tg.showAlert('–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            btnCashOut.disabled = false;
          });
      });
    }
    const btnMainMenuOut = document.getElementById('btnMainMenuOut');
    if (btnMainMenuOut) {
      btnMainMenuOut.addEventListener('click', goToMainMenu);
    }
  }

  async function submitTwoTeams() {
    if (selectedIds.length !== 2) {
      if (tg) tg.showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–≤–Ω–æ –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã');
      return;
    }
    var ti = currentTicketIndex != null ? currentTicketIndex : 1;
    submitBtn.disabled = true;
    submitBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶';
    try {
      var r = await fetch(baseUrl + '/api/entry/' + entryId + '/submit_teams', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ team1_id: selectedIds[0], team2_id: selectedIds[1], ticket_index: ti })
      });
      var data = await r.json().catch(function () { return {}; });
      if (!r.ok) {
        if (tg) tg.showAlert(data.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        else alert(data.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä';
        return;
      }
      currentTicketIndex = null;
      roundData = await loadTeamsForRound();
      renderMain(roundData);
      if (tg) tg.showAlert('–ë–∏–ª–µ—Ç ' + ti + ': –≤—ã–±–æ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
      submitBtn.disabled = false;
      submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä';
    } catch (e) {
      if (tg) tg.showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      else alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
      submitBtn.disabled = false;
      submitBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä';
    }
  }

  submitBtn.addEventListener('click', submitTwoTeams);

  (async function init() {
    try {
      var data = await loadTeamsForRound();
      var hasData = (data.teams && data.teams.length > 0) || (data.matches && data.matches.length > 0);
      if (hasData) {
        renderTeamList(data);
        var runBtn = document.getElementById('btnRunRound');
        if (runBtn) runBtn.addEventListener('click', onRunRoundClick);
        return;
      }
      contentEl.innerHTML = '<p class="info">–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç—É—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∑–∂–µ.</p>';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      roundEl.style.display = 'none';
      document.getElementById('runRoundWrap').style.display = 'none';
    } catch (e) {
      contentEl.innerHTML = '<p class="error">' + escapeHtml(e.message) + '</p>';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      roundEl.style.display = 'none';
      document.getElementById('runRoundWrap').style.display = 'none';
    }
  })();
})();
  </script>
</body>
</html>
