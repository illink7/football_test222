<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Survivor — Обрати матчі</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #1a1a2e;
      --tg-theme-text-color: #eee;
      --tg-theme-button-color: #16213e;
      --tg-theme-button-text-color: #eee;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      margin: 0;
      padding: 16px;
      min-height: 100vh;
    }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .round { opacity: 0.8; font-size: 0.9rem; margin-bottom: 16px; }
    .loading, .error { padding: 12px; text-align: center; }
    .error { color: #f88; }
    .info { color: #8cf; margin-bottom: 12px; }
    .success-msg { color: #8f8; margin-top: 16px; }
    .match-row {
      display: block;
      width: 100%;
      padding: 12px 14px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      text-align: center;
      background: rgba(255,255,255,0.06);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .match-row:hover { background: rgba(255,255,255,0.1); }
    .match-row.selected {
      background: rgba(76, 175, 80, 0.35);
      border-color: #4CAF50;
    }
    .match-row .vs { opacity: 0.7; margin: 0 6px; }
    select {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      font-size: 1rem;
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-text-color);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
    }
    option { background: #1a1a2e; color: #eee; }
    button {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 8px;
      margin-top: 12px;
      cursor: pointer;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .summary-list { text-align: left; margin: 12px 0; padding-left: 16px; }
  </style>
</head>
<body>
  <h1 id="title">Обрати матчі</h1>
  <p class="round" id="roundInfo">Раунд —</p>
  <div id="content">
    <p class="loading">Завантаження…</p>
  </div>
  <button type="button" id="submitBtn" disabled>Підтвердити</button>

  <script>
    (function () {
      const tg = window.Telegram?.WebApp;
      if (tg) tg.ready();

      const urlParams = new URLSearchParams(window.location.search);
      const entryId = urlParams.get('entry_id');
      const baseUrl = window.location.origin;

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      if (!entryId) {
        document.getElementById('content').innerHTML =
          '<p class="info">Survivor Football</p>' +
          '<p>Надішли боту команду <b>/start</b> — там з\'явиться кнопка «Обрати команди» для твого entry.</p>' +
          '<p>Якщо записів ще немає, адмін має створити гру та додати тобі entry.</p>';
        document.getElementById('roundInfo').textContent = '';
        document.getElementById('submitBtn').style.display = 'none';
        return;
      }

      const titleEl = document.getElementById('title');
      const roundEl = document.getElementById('roundInfo');
      const contentEl = document.getElementById('content');
      const submitBtn = document.getElementById('submitBtn');

      let matchesData = [];
      let selectedMatchIds = new Set();

      async function loadMatches() {
        const r = await fetch(baseUrl + '/api/entry/' + entryId + '/matches');
        if (!r.ok) throw new Error('Не вдалося завантажити матчі');
        return r.json();
      }

      function renderMatchList(data) {
        matchesData = data.matches || [];
        selectedMatchIds = new Set(matchesData.filter(m => m.selected).map(m => m.id));
        roundEl.textContent = 'Раунд ' + data.round;

        if (matchesData.length === 0) {
          contentEl.innerHTML = '<p class="info">Матчів для цього раунду ще немає. Адмін додасть їх командою /add_matches.</p>';
          submitBtn.style.display = 'none';
          return;
        }

        const html = matchesData.map(m => {
          const cls = selectedMatchIds.has(m.id) ? 'match-row selected' : 'match-row';
          return '<div class="' + cls + '" data-match-id="' + m.id + '" role="button" tabindex="0">' +
            escapeHtml(m.home_name) + '<span class="vs">—</span>' + escapeHtml(m.away_name) + '</div>';
        }).join('');
        contentEl.innerHTML = html;

        contentEl.querySelectorAll('.match-row').forEach(row => {
          row.addEventListener('click', function () {
            const id = parseInt(this.dataset.matchId, 10);
            if (selectedMatchIds.has(id)) selectedMatchIds.delete(id);
            else selectedMatchIds.add(id);
            this.classList.toggle('selected', selectedMatchIds.has(id));
          });
        });

        submitBtn.textContent = 'Підтвердити';
        submitBtn.style.display = 'block';
        submitBtn.disabled = false;
      }

      async function submitMatches() {
        const ids = Array.from(selectedMatchIds);
        if (ids.length === 0) {
          if (tg) tg.showAlert('Оберіть хоча б один матч.');
          else alert('Оберіть хоча б один матч.');
          return;
        }
        submitBtn.disabled = true;
        try {
          const r = await fetch(baseUrl + '/api/entry/' + entryId + '/matches', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ entry_id: parseInt(entryId, 10), match_ids: ids })
          });
          const data = await r.json().catch(() => ({}));
          if (!r.ok) {
            if (tg) tg.showAlert(data.detail || 'Помилка збереження.');
            else alert(data.detail || 'Помилка збереження.');
            submitBtn.disabled = false;
            return;
          }
          const names = matchesData.filter(m => ids.includes(m.id))
            .map(m => m.home_name + ' — ' + m.away_name);
          contentEl.innerHTML =
            '<p class="success-msg">Ви обрали:</p>' +
            '<ul class="summary-list">' + names.map(n => '<li>' + escapeHtml(n) + '</li>').join('') + '</ul>' +
            '<p class="success-msg">Чекайте результатів.</p>';
          submitBtn.style.display = 'none';
          roundEl.textContent = '';
          titleEl.textContent = 'Готово';
          if (tg) tg.ready();
        } catch (e) {
          if (tg) tg.showAlert('Помилка мережі.');
          else alert('Помилка мережі.');
          submitBtn.disabled = false;
        }
      }

      submitBtn.addEventListener('click', submitMatches);

      (async function init() {
        try {
          const data = await loadMatches();
          if (data.matches && data.matches.length > 0) {
            renderMatchList(data);
            return;
          }
          contentEl.innerHTML = '<p class="info">Матчів для цього раунду немає. Скоро з\'являться або оберіть 2 команди (старий режим).</p>';
          submitBtn.style.display = 'none';
        } catch (e) {
          contentEl.innerHTML = '<p class="error">' + escapeHtml(e.message) + '</p>';
          submitBtn.style.display = 'none';
        }
      })();
    })();
  </script>
</body>
</html>
