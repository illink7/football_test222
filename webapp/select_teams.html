<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–û–±—Ä–∞—Ç–∏ –¥–≤—ñ –∫–æ–º–∞–Ω–¥–∏ ‚Äî Survivor Football</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #1a1a2e;
      --tg-theme-text-color: #eee;
      --tg-theme-button-color: #0f3460;
      --accent: #e94560;
      --success: #4ecca3;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container { max-width: 420px; margin: 0 auto; padding: 20px 16px; }
    .header {
      text-align: center;
      padding: 16px 0 20px;
      border-bottom: 1px solid var(--card-border);
    }
    .header h1 { font-size: 1.35rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .round-badge {
      display: inline-block;
      font-size: 0.85rem;
      opacity: 0.85;
      margin-top: 8px;
      padding: 6px 12px;
      background: var(--card-bg);
      border-radius: 20px;
    }
    .intro {
      text-align: center;
      padding: 12px 0 16px;
      font-size: 0.95rem;
      line-height: 1.4;
      opacity: 0.95;
    }
    .content { padding: 8px 0 20px; }
    .loading { text-align: center; padding: 40px 20px; opacity: 0.9; }
    .error { color: #e94560; padding: 16px; text-align: center; background: rgba(233,69,96,0.1); border-radius: 12px; margin-bottom: 16px; }
    .info { color: #8cf; padding: 16px; text-align: center; line-height: 1.5; }
    .team-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      margin-bottom: 8px;
      background: var(--card-bg);
      border: 2px solid var(--card-border);
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
    }
    .team-row:active { opacity: 0.95; }
    .team-row.selected {
      background: rgba(78, 204, 163, 0.2);
      border-color: var(--success);
    }
    .team-row .check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.4); flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; }
    .team-row.selected .check { background: var(--success); border-color: var(--success); color: #1a1a2e; }
    .team-row.used { background: rgba(233, 69, 96, 0.2); border-color: rgba(233, 69, 96, 0.5); cursor: not-allowed; opacity: 0.9; }
    .team-row.used .name { opacity: 0.9; }
    .team-row .name { flex: 1; font-size: 1rem; }
    .counter { font-size: 0.85rem; opacity: 0.8; margin-bottom: 12px; text-align: center; }
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 16px 20px;
      font-size: 1.05rem;
      font-weight: 600;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      margin-top: 8px;
      transition: opacity 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-success { background: var(--success); color: #1a1a2e; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .success-screen { text-align: center; padding: 32px 20px; }
    .success-screen .icon { font-size: 3rem; margin-bottom: 16px; }
    .success-screen h2 { font-size: 1.25rem; margin: 0 0 12px; }
    .success-screen .chosen { font-size: 1.1rem; margin: 16px 0; line-height: 1.6; }
    .success-screen .wait { color: var(--success); font-weight: 500; margin-top: 24px; }
    .countdown-screen { text-align: center; padding: 32px 20px; }
    .countdown-screen .big-num { font-size: 4rem; font-weight: 700; color: var(--accent); line-height: 1.2; margin: 16px 0; }
    .countdown-screen .hint { font-size: 0.95rem; opacity: 0.9; margin-top: 12px; }
    .results-screen { padding: 20px 0; }
    .results-screen .icon { font-size: 3rem; margin-bottom: 12px; text-align: center; }
    .results-screen h2 { font-size: 1.25rem; margin: 0 0 16px; text-align: center; }
    .results-screen .message { text-align: center; margin-bottom: 20px; font-size: 1.05rem; line-height: 1.5; }
    .results-screen .message.passed { color: var(--success); }
    .results-screen .message.out { color: var(--accent); }
    .match-score { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; margin-bottom: 8px; background: var(--card-bg); border-radius: 10px; font-size: 0.95rem; }
    .match-score .score { font-weight: 600; margin: 0 8px; }
    .btn-next { margin-top: 20px; background: var(--success); color: #1a1a2e; }
    .btn-row { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .btn-row .btn { margin-top: 0; }
    .btn-outline { background: transparent; border: 2px solid var(--success); color: var(--success); }
    .win-screen { text-align: center; padding: 28px 20px; }
    .win-screen .icon { font-size: 3rem; margin-bottom: 12px; }
    .win-screen h2 { font-size: 1.25rem; margin: 0 0 8px; }
    .win-screen .amount { font-size: 1.5rem; font-weight: 700; color: var(--success); margin: 16px 0; }
    .stake-line { font-size: 0.95rem; color: var(--success); font-weight: 600; margin-top: 8px; }
    .stake-line .muted { font-weight: normal; opacity: 0.85; font-size: 0.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>‚öΩ –û–±—Ä–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏</h1>
      <div class="round-badge" id="roundInfo">–¢—É—Ä ‚Äî</div>
      <p class="stake-line" id="stakeLine" style="display:none;">–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: <span id="stakeValue">‚Äî</span> –≥—Ä–Ω <span class="muted">(√ó1.5 –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç—É—Ä—É)</span></p>
    </header>

    <p class="intro" id="intro">–í–∏–±–µ—Ä—ñ—Ç—å –¥–≤—ñ –∫–æ–º–∞–Ω–¥–∏, —è–∫—ñ –∑–∞–±'—é—Ç—å –≥–æ–ª —É —Ü—å–æ–º—É —Ç—É—Ä—ñ. –£ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö —Ç—É—Ä–∞—Ö –Ω–µ –º–æ–∂–Ω–∞ –≤–∏–±–∏—Ä–∞—Ç–∏ –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –∫–æ–º–∞–Ω–¥–∏.</p>

    <div id="content" class="content">
      <p class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</p>
    </div>

    <p class="counter" id="counter" style="display:none;">–û–±—Ä–∞–Ω–æ: 0 –∑ 2</p>
    <button type="button" id="submitBtn" class="btn btn-success" disabled style="display:none;">
      –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
    </button>
  </div>

  <script>
(function () {
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const urlParams = new URLSearchParams(window.location.search);
  const entryId = urlParams.get('entry_id');
  const baseUrl = window.location.origin;

  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  if (!entryId) {
    document.getElementById('content').innerHTML =
      '<p class="info">–í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫ –∑ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é –±–æ—Ç–∞ ‚Äî —Ç–∞–º –±—É–¥—É—Ç—å –≤–∞—à—ñ –∑–∞–ø–∏—Å–∏ —Ç–∞ –∫–Ω–æ–ø–∫–∞ ¬´–û–±—Ä–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏¬ª.</p>' +
      '<p class="info">–Ø–∫—â–æ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î, –∞–¥–º—ñ–Ω –¥–æ–¥–∞—Å—Ç—å –≤–∞—Å —É –≥—Ä—É.</p>';
    document.getElementById('roundInfo').style.display = 'none';
    document.getElementById('intro').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
    return;
  }

  const roundEl = document.getElementById('roundInfo');
  const stakeLineEl = document.getElementById('stakeLine');
  const stakeValueEl = document.getElementById('stakeValue');
  const introEl = document.getElementById('intro');
  const contentEl = document.getElementById('content');
  const counterEl = document.getElementById('counter');
  const submitBtn = document.getElementById('submitBtn');

  function formatStake(n) {
    if (n == null || n === undefined) return '‚Äî';
    const x = Number(n);
    return x % 1 === 0 ? String(x) : x.toFixed(1);
  }

  let teamsData = [];
  let selectedIds = [];

  async function loadTeamsForRound() {
    const r = await fetch(baseUrl + '/api/entry/' + entryId + '/teams_for_round');
    if (!r.ok) throw new Error('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥');
    return r.json();
  }

  function renderTeamList(data) {
    teamsData = data.teams || [];
    const usedSet = new Set((data.used_team_ids || []).map(Number));
    roundEl.textContent = '–¢—É—Ä ' + data.round;
    roundEl.style.display = 'inline-block';
    if (data.stake != null) {
      stakeValueEl.textContent = formatStake(data.stake);
      stakeLineEl.style.display = 'block';
    } else {
      stakeLineEl.style.display = 'none';
    }

    if (teamsData.length === 0) {
      contentEl.innerHTML = '<p class="info">–ö–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ü—å–æ–≥–æ —Ç—É—Ä—É —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ. –ê–¥–º—ñ–Ω –¥–æ–¥–∞—Å—Ç—å –º–∞—Ç—á—ñ ‚Äî —Ç–æ–¥—ñ –∑\'—è–≤–∏—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ–∑–Ω—ñ—à–µ.</p>';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      return;
    }

    selectedIds = [];
    const html = teamsData.map(t => {
      const used = usedSet.has(t.id);
      const cls = 'team-row' + (used ? ' used' : '');
      return '<div class="' + cls + '" data-team-id="' + t.id + '" data-used="' + (used ? '1' : '0') + '" role="button" tabindex="0">' +
        '<span class="check"></span>' +
        '<span class="name">' + escapeHtml(t.name) + (used ? ' (–≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∞—Å—å)' : '') + '</span>' +
      '</div>';
    }).join('');
    contentEl.innerHTML = html;
    counterEl.style.display = 'block';
    counterEl.textContent = '–û–±—Ä–∞–Ω–æ: 0 –∑ 2';
    submitBtn.style.display = 'block';
    submitBtn.disabled = true;

    contentEl.querySelectorAll('.team-row').forEach(row => {
      row.addEventListener('click', function () {
        if (this.dataset.used === '1') return;
        const id = parseInt(this.dataset.teamId, 10);
        const idx = selectedIds.indexOf(id);
        if (idx >= 0) {
          selectedIds.splice(idx, 1);
          this.classList.remove('selected');
          this.querySelector('.check').textContent = '';
        } else if (selectedIds.length < 2) {
          selectedIds.push(id);
          this.classList.add('selected');
          this.querySelector('.check').textContent = '‚úì';
        }
        counterEl.textContent = '–û–±—Ä–∞–Ω–æ: ' + selectedIds.length + ' –∑ 2';
        submitBtn.disabled = selectedIds.length !== 2;
      });
    });
  }

  function startCountdownThenRunRound() {
    const countdownEl = contentEl.querySelector('.success-screen');
    if (!countdownEl) return;
    const waitEl = countdownEl.querySelector('.wait');
    let sec = 10;
    function tick() {
      if (sec > 0) {
        waitEl.textContent = sec + '‚Ä¶ –°–∫–æ—Ä–æ –±—É–¥—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.';
        sec--;
        setTimeout(tick, 1000);
        return;
      }
      waitEl.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤‚Ä¶';
      fetch(baseUrl + '/api/entry/' + entryId + '/run_round', { method: 'POST' })
        .then(r => r.json())
        .then(function (data) {
          showResultsScreen(data);
        })
        .catch(function () {
          if (tg) tg.showAlert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏');
          else alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏');
          waitEl.textContent = '–ü–æ–º–∏–ª–∫–∞. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É.';
        });
    }
    tick();
  }

  function goToMainMenu() {
    window.location.href = baseUrl + '/';
  }

  function showResultsScreen(data) {
    const passed = data.passed === true;
    let html = '<div class="results-screen">';
    html += '<div class="icon">' + (passed ? '‚úÖ' : '‚ùå') + '</div>';
    html += '<h2>' + (passed ? '–í–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –¥–∞–ª—ñ!' : '–í–∏ –≤–∏–±—É–≤–∞—î—Ç–µ') + '</h2>';
    html += '<p class="message ' + (passed ? 'passed' : 'out') + '">' + escapeHtml(data.message || '') + '</p>';
    if (data.stake_after_round != null) {
      html += '<p class="stake-line">–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ —Ç–µ–ø–µ—Ä: <strong>' + formatStake(data.stake_after_round) + '</strong> –≥—Ä–Ω</p>';
    }
    if (data.matches && data.matches.length) {
      data.matches.forEach(function (m) {
        html += '<div class="match-score">' +
          '<span>' + escapeHtml(m.home_name) + '</span>' +
          '<span class="score">' + m.home_goals + ' : ' + m.away_goals + '</span>' +
          '<span>' + escapeHtml(m.away_name) + '</span>' +
        '</div>';
      });
    }
    if (passed) {
      html += '<div class="btn-row">';
      html += '<button type="button" class="btn btn-success" id="btnNextRound">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –¥–∞–ª—ñ</button>';
      html += '<button type="button" class="btn btn-outline" id="btnCashOut">–ó–∞–±—Ä–∞—Ç–∏ –≤–∏–≥—Ä–∞—à</button>';
      html += '</div>';
    } else {
      html += '<button type="button" class="btn btn-success btn-next" id="btnMainMenuOut">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –Ω–∞ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>';
    }
    html += '</div>';
    contentEl.innerHTML = html;
    const btnNext = document.getElementById('btnNextRound');
    if (btnNext) {
      btnNext.addEventListener('click', function () {
        window.location.reload();
      });
    }
    const btnCashOut = document.getElementById('btnCashOut');
    if (btnCashOut) {
      btnCashOut.addEventListener('click', function () {
        btnCashOut.disabled = true;
        fetch(baseUrl + '/api/entry/' + entryId + '/cash_out', { method: 'POST' })
          .then(function (r) { return r.json(); })
          .then(function (res) {
            const amount = res.amount != null ? formatStake(res.amount) : '0';
            contentEl.innerHTML =
              '<div class="results-screen win-screen">' +
                '<div class="icon">üèÜ</div>' +
                '<h2>–í–∏ –≤–∏–≥—Ä–∞–ª–∏!</h2>' +
                '<p class="amount">' + amount + ' –≥—Ä–Ω</p>' +
                '<p class="message passed">–í–∏ –∑–∞–±—Ä–∞–ª–∏ –≤–∏–≥—Ä–∞—à. –î—è–∫—É—î–º–æ –∑–∞ –≥—Ä—É!</p>' +
                '<button type="button" class="btn btn-success btn-next" id="btnMainMenuWin">–ù–∞ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>' +
              '</div>';
            document.getElementById('btnMainMenuWin').addEventListener('click', goToMainMenu);
          })
          .catch(function () {
            if (tg) tg.showAlert('–ü–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            btnCashOut.disabled = false;
          });
      });
    }
    const btnMainMenuOut = document.getElementById('btnMainMenuOut');
    if (btnMainMenuOut) {
      btnMainMenuOut.addEventListener('click', goToMainMenu);
    }
  }

  async function submitTwoTeams() {
    if (selectedIds.length !== 2) {
      if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å —Ä—ñ–≤–Ω–æ –¥–≤—ñ –∫–æ–º–∞–Ω–¥–∏');
      return;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è‚Ä¶';
    try {
      const r = await fetch(baseUrl + '/api/entry/' + entryId + '/submit_teams', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ team1_id: selectedIds[0], team2_id: selectedIds[1] })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        if (tg) tg.showAlert(data.detail || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
        else alert(data.detail || '–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è');
        submitBtn.disabled = false;
        submitBtn.textContent = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏';
        return;
      }
      const names = teamsData.filter(t => selectedIds.includes(t.id)).map(t => t.name);
      introEl.style.display = 'none';
      counterEl.style.display = 'none';
      submitBtn.style.display = 'none';
      roundEl.style.display = 'none';
      contentEl.innerHTML =
        '<div class="success-screen">' +
          '<div class="icon">‚úÖ</div>' +
          '<h2>–í–∞—à –≤–∏–±—ñ—Ä –∑–±–µ—Ä–µ–∂–µ–Ω–æ</h2>' +
          '<p class="chosen">–í–∏ –æ–±—Ä–∞–ª–∏: <strong>' + escapeHtml(names[0]) + '</strong> —Ç–∞ <strong>' + escapeHtml(names[1]) + '</strong>.</p>' +
          '<p class="wait">–°–∫–æ—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ ‚Äî —á–µ–∫–∞–π—Ç–µ 10 —Å–µ–∫—É–Ω–¥.</p>' +
        '</div>';
      if (tg) tg.ready();
      startCountdownThenRunRound();
    } catch (e) {
      if (tg) tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
      else alert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ');
      submitBtn.disabled = false;
      submitBtn.textContent = '–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏';
    }
  }

  submitBtn.addEventListener('click', submitTwoTeams);

  (async function init() {
    try {
      const data = await loadTeamsForRound();
      if (data.teams && data.teams.length > 0) {
        renderTeamList(data);
        return;
      }
      contentEl.innerHTML = '<p class="info">–ö–æ–º–∞–Ω–¥–∏ –¥–ª—è —Ü—å–æ–≥–æ —Ç—É—Ä—É –ø–æ–∫–∏ –Ω–µ –¥–æ–¥–∞–Ω–æ. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ–∑–Ω—ñ—à–µ.</p>';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      roundEl.style.display = 'none';
    } catch (e) {
      contentEl.innerHTML = '<p class="error">' + escapeHtml(e.message) + '</p>';
      submitBtn.style.display = 'none';
      counterEl.style.display = 'none';
      roundEl.style.display = 'none';
    }
  })();
})();
  </script>
</body>
</html>
