<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Survivor Football</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #1a1a2e;
      --tg-theme-text-color: #eee;
      --tg-theme-button-color: #16213e;
      --tg-theme-button-text-color: #eee;
    }
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); margin: 0; padding: 16px; min-height: 100vh; }
    h1 { font-size: 1.25rem; margin: 0 0 16px; }
    .loading { padding: 24px; text-align: center; }
    .error { color: #f88; padding: 12px; }
    .section { margin-bottom: 24px; }
    .section h2 { font-size: 1rem; margin: 0 0 8px; opacity: 0.9; }
    input, textarea, button, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 8px;
      font-size: 1rem;
      background: rgba(255,255,255,0.08);
      color: var(--tg-theme-text-color);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
    }
    button { background: var(--tg-theme-button-color); cursor: pointer; border: none; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .card { background: rgba(255,255,255,0.06); border-radius: 10px; padding: 12px; margin-bottom: 10px; }
    .card a { color: #6af; text-decoration: none; }
    .card a:active { opacity: 0.8; }
    .badge { font-size: 0.75rem; opacity: 0.8; margin-left: 8px; }
    .admin-only { display: none; }
    .user-only { display: none; }
    body.admin .admin-only { display: block; }
    body.user .user-only { display: block; }
  </style>
</head>
<body>
  <h1>Survivor Football</h1>
  <div id="loading" class="loading">Завантаження…</div>
  <div id="error" class="error" style="display:none;"></div>
  <div id="admin" class="admin-only">
    <div class="section">
      <h2>Створити гру</h2>
      <input type="text" id="newGameTitle" placeholder="Назва гри" />
      <button type="button" id="btnCreateGame">Створити</button>
    </div>
    <div class="section">
      <h2>Ігри</h2>
      <div id="gamesList"></div>
    </div>
    <div class="section">
      <h2>Додати матчі до раунду</h2>
      <select id="addMatchGameId"><option value="">— оберіть гру —</option></select>
      <input type="number" id="addMatchRound" placeholder="Номер раунду" min="1" value="1" />
      <textarea id="addMatchText" rows="6" placeholder="Один матч на рядок: Дім — Гость&#10;Наприклад:&#10;Вулвергемптон — Арсенал&#10;Борнмут — Манчестер Юнайтед"></textarea>
      <button type="button" id="btnAddMatches">Додати матчі</button>
    </div>
    <div class="section">
      <h2>Додати entry учаснику</h2>
      <select id="addEntryGameId"><option value="">— оберіть гру —</option></select>
      <input type="number" id="addEntryUserId" placeholder="Telegram ID (порожньо = ви)" />
      <button type="button" id="btnAddEntry">Додати entry</button>
    </div>
  </div>
  <div id="user" class="user-only">
    <div class="section">
      <h2>Мої записи</h2>
      <div id="entriesList"></div>
      <p class="badge">Якщо записів немає — адмін має додати вам entry.</p>
    </div>
  </div>

  <script>
(function () {
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const baseUrl = window.location.origin;
  let initData = '';
  if (tg && tg.initData) initData = tg.initData;

  function qs(p) { return 'init_data=' + encodeURIComponent(initData); }

  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');
  const adminEl = document.getElementById('admin');
  const userEl = document.getElementById('user');

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
    loadingEl.style.display = 'none';
  }

  function showContent(me) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'none';
    document.body.classList.add(me.is_admin ? 'admin' : 'user');

    if (me.is_admin) {
      fillGamesSelects(me.games || []);
      renderGamesList(me.games || []);
      document.getElementById('btnCreateGame').onclick = createGame;
      document.getElementById('btnAddMatches').onclick = addMatches;
      document.getElementById('btnAddEntry').onclick = addEntry;
    } else {
      renderEntriesList(me.entries || []);
    }
  }

  function fillGamesSelects(games) {
    const opts = games.map(g => '<option value="' + g.id + '">' + escapeHtml(g.title) + ' (id=' + g.id + ', раунд ' + g.current_round + ')</option>').join('');
    document.getElementById('addMatchGameId').innerHTML = '<option value="">— оберіть гру —</option>' + opts;
    document.getElementById('addEntryGameId').innerHTML = '<option value="">— оберіть гру —</option>' + opts;
  }

  function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function renderGamesList(games) {
    const html = games.length
      ? games.map(g => '<div class="card">' + escapeHtml(g.title) + ' <span class="badge">id=' + g.id + ', раунд ' + g.current_round + '/' + g.rounds_total + ', ' + g.status + '</span></div>').join('')
      : '<p class="badge">Ігор поки немає. Створіть гру вище.</p>';
    document.getElementById('gamesList').innerHTML = html;
    fillGamesSelects(games);
  }

  function renderEntriesList(entries) {
    const webAppUrl = baseUrl + '/select_teams';
    const html = entries.length
      ? entries.map(e => {
          const canPick = e.status === 'active';
          const link = canPick ? (webAppUrl + '?entry_id=' + e.entry_id) : '#';
          return '<div class="card">' + escapeHtml(e.game_title) + ' <span class="badge">раунд ' + e.current_round + '/' + e.rounds_total + ', ' + e.status + '</span><br><a href="' + link + '">' + (canPick ? 'Обрати матчі' : 'Чекайте результатів') + '</a></div>';
        }).join('')
      : '<p class="badge">У вас ще немає записів. Адмін додасть entry для вас.</p>';
    document.getElementById('entriesList').innerHTML = html;
  }

  async function createGame() {
    const title = document.getElementById('newGameTitle').value.trim();
    if (!title) { if (tg) tg.showAlert('Введіть назву гри'); return; }
    try {
      const r = await fetch(baseUrl + '/api/games?' + qs(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title }) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || 'Помилка');
      if (tg) tg.showAlert('Гру створено: ' + data.title);
      document.getElementById('newGameTitle').value = '';
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function addMatches() {
    const gameId = document.getElementById('addMatchGameId').value;
    const round = parseInt(document.getElementById('addMatchRound').value, 10);
    const text = document.getElementById('addMatchText').value;
    if (!gameId || !round) { if (tg) tg.showAlert('Оберіть гру та раунд'); return; }
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (!lines.length) { if (tg) tg.showAlert('Введіть хоча б один матч (Дім — Гость)'); return; }
    try {
      const r = await fetch(baseUrl + '/api/games/' + gameId + '/matches?' + qs(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ round, matches: lines }) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || 'Помилка');
      if (tg) tg.showAlert('Додано матчів: ' + (data.added || 0));
      document.getElementById('addMatchText').value = '';
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function addEntry() {
    const gameId = document.getElementById('addEntryGameId').value;
    const userIdInput = document.getElementById('addEntryUserId').value.trim();
    if (!gameId) { if (tg) tg.showAlert('Оберіть гру'); return; }
    const body = { game_id: parseInt(gameId, 10) };
    if (userIdInput) body.user_id = parseInt(userIdInput, 10);
    try {
      const r = await fetch(baseUrl + '/api/entries?' + qs(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || 'Помилка');
      if (tg) tg.showAlert('Entry #' + data.entry_id + ' додано');
      document.getElementById('addEntryUserId').value = '';
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function loadMe() {
    if (!initData) {
      showError('Відкрийте додаток з Telegram (кнопка меню бота або /start).');
      return;
    }
    try {
      const r = await fetch(baseUrl + '/api/me?' + qs());
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        showError(data.detail || 'Помилка авторизації');
        return;
      }
      showContent(data);
    } catch (e) {
      showError('Помилка мережі: ' + e.message);
    }
  }

  loadMe();
})();
  </script>
</body>
</html>
