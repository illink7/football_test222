<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Survivor Football</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #0d1f0d;
      --tg-theme-text-color: #e8e0c8;
      --tg-theme-button-color: #1a3d1a;
      --tg-theme-button-text-color: #e8e0c8;
      --pitch: #0d1f0d;
      --grass: #143814;
      --gold: #d4a84b;
      --gold-light: #e8c97a;
      --accent: #c9302c;
      --success: #2d8a47;
      --card-bg: rgba(20, 56, 20, 0.85);
      --card-border: rgba(212, 168, 75, 0.35);
      --wood: #2c1810;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Outfit', -apple-system, sans-serif;
      background: var(--pitch);
      background-image: radial-gradient(ellipse at 50% 0%, rgba(45, 138, 71, 0.15) 0%, transparent 50%),
        linear-gradient(180deg, var(--grass) 0%, var(--pitch) 100%);
      color: var(--tg-theme-text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .font-pirate { font-family: 'Pirata One', cursive; }
    .container { max-width: 420px; margin: 0 auto; padding: 20px 16px; }
    .header {
      text-align: center;
      padding: 20px 0 24px;
      border-bottom: 1px solid var(--card-border);
    }
    .header h1 { font-size: 1.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .header .sub { font-size: 0.85rem; opacity: 0.7; margin-top: 6px; }
    .loading { padding: 40px 24px; text-align: center; font-size: 1rem; opacity: 0.9; }
    .error { background: rgba(233,69,96,0.15); color: #e94560; padding: 16px; border-radius: 12px; margin: 16px; text-align: center; white-space: pre-line; }
    .section {
      margin: 24px 0;
    }
    .section-title {
      font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;
      color: var(--gold-light); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .card:last-child { margin-bottom: 0; }
    .header { border-bottom-color: var(--card-border); }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #fff; border: 1px solid rgba(201,48,44,0.6); }
    .btn-secondary { background: var(--wood); color: var(--gold-light); border: 1px solid var(--card-border); }
    .btn-success { background: var(--success); color: #fff; border: 1px solid rgba(45,138,71,0.6); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    input, textarea, select {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 12px;
      font-size: 1rem;
      background: rgba(255,255,255,0.08);
      color: var(--tg-theme-text-color);
      border: 1px solid var(--card-border);
      border-radius: 12px;
    }
    input::placeholder, textarea::placeholder { opacity: 0.6; }
    select { cursor: pointer; }
    .form-row { margin-bottom: 12px; }
    .form-row:last-child { margin-bottom: 0; }
    .field-label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 6px; display: block; }
    .hint { font-size: 0.8rem; opacity: 0.7; margin-top: 6px; }
    .balance-line { font-size: 1rem; margin-bottom: 12px; color: var(--gold); }
    .balance-line strong { font-weight: 700; }
    .error-inline { color: #e94560; opacity: 1; }
    .admin-only { display: none; }
    .user-only { display: none; }
    body.admin .admin-only { display: block; }
    body.user .user-only { display: block; }
    .entry-card {
      display: block;
      text-decoration: none;
      color: inherit;
      padding: 18px;
      border-radius: 14px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      margin-bottom: 12px;
      transition: background 0.2s, border-color 0.2s;
    }
    .entry-card:active { background: rgba(255,255,255,0.1); }
    .entry-card .game-name { font-weight: 600; font-size: 1.05rem; margin-bottom: 6px; }
    .entry-card .meta { font-size: 0.85rem; opacity: 0.8; margin-bottom: 12px; }
    .entry-card .cta {
      display: inline-flex; align-items: center; gap: 8px;
      color: var(--gold-light); font-weight: 600; font-size: 0.95rem;
    }
    .entry-card.disabled .cta { color: var(--tg-theme-text-color); opacity: 0.7; }
    .game-card-admin { padding: 14px 16px; }
    .game-card-admin .name { font-weight: 600; margin-bottom: 4px; }
    .game-card-admin .meta { font-size: 0.8rem; opacity: 0.75; }
    .matches-preview {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--card-border);
    }
    .matches-preview .preview-title { font-size: 0.8rem; opacity: 0.8; margin-bottom: 8px; }
    .match-line { font-size: 0.9rem; padding: 4px 0; opacity: 0.95; }
    .expand-toggle { font-size: 0.85rem; color: var(--accent); cursor: pointer; margin-top: 8px; }

    /* Splash: football animation */
    #splash {
      position: fixed; inset: 0; z-index: 9999;
      background: linear-gradient(180deg, #0d1f0d 0%, #143814 50%, #0d1f0d 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.6s ease;
    }
    #splash.hide { opacity: 0; pointer-events: none; }
    .splash-ball {
      width: 80px; height: 80px; font-size: 80px; line-height: 1;
      animation: bounce 0.8s ease-in-out infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0) scale(1); }
      50% { transform: translateY(-24px) scale(1.05); }
    }
    .splash-title { font-family: 'Pirata One', cursive; font-size: 1.8rem; color: var(--gold); margin-top: 24px; letter-spacing: 0.02em; }
    .splash-sub { font-size: 0.9rem; color: var(--gold-light); opacity: 0.9; margin-top: 8px; }

    /* Tabs (user) */
    .tabs-wrap { display: flex; gap: 0; margin: 0 -16px 20px; border-bottom: 2px solid var(--card-border); }
    .tab-btn {
      flex: 1; padding: 14px 16px; font-family: 'Outfit', sans-serif; font-size: 1rem; font-weight: 600;
      background: transparent; color: var(--tg-theme-text-color); opacity: 0.6; border: none; border-bottom: 3px solid transparent;
      cursor: pointer; transition: opacity 0.2s, color 0.2s, border-color 0.2s;
    }
    .tab-btn.active { opacity: 1; color: var(--gold); border-bottom-color: var(--gold); }
    .tab-btn:active { opacity: 0.9; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Profile */
    .profile-balance-card {
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(44, 24, 16, 0.9) 100%);
      border: 2px solid var(--gold);
      border-radius: 16px; padding: 24px; text-align: center; margin-bottom: 20px;
      box-shadow: 0 0 20px rgba(212, 168, 75, 0.15);
    }
    .profile-balance-label { font-size: 0.85rem; color: var(--gold-light); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; }
    .profile-balance-value { font-family: 'Pirata One', cursive; font-size: 2.5rem; color: var(--gold); }
    .profile-balance-value span { font-size: 1rem; opacity: 0.9; margin-left: 4px; }
    .profile-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
    .profile-actions .btn { font-size: 0.9rem; padding: 12px; }
    .profile-actions .btn:disabled { opacity: 0.7; cursor: default; }
    .history-item {
      padding: 14px 16px; margin-bottom: 10px; border-radius: 12px;
      background: var(--card-bg); border: 1px solid var(--card-border);
      display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;
    }
    .history-item.win { border-left: 4px solid var(--success); }
    .history-item.loss { border-left: 4px solid var(--accent); }
    .history-item.active { border-left: 4px solid var(--gold); }
    .history-game { font-weight: 600; font-size: 1rem; }
    .history-meta { font-size: 0.85rem; opacity: 0.85; }
    .history-result { font-weight: 600; font-size: 0.95rem; }
    .history-result.win { color: var(--success); }
    .history-result.loss { color: var(--accent); }
    .history-result.active { color: var(--gold); }
    .soon { font-size: 0.75rem; opacity: 0.8; font-weight: normal; }
  </style>
</head>
<body>
  <div id="splash">
    <div class="splash-ball" aria-hidden="true">‚öΩ</div>
    <div class="splash-title font-pirate">Survivor Football</div>
    <p class="splash-sub">–§—É—Ç–±–æ–ª —ñ —Å–∫–∞—Ä–±–∏</p>
  </div>

  <div class="container" id="mainContainer" style="opacity:0; transition: opacity 0.5s ease;">
    <header class="header">
      <h1 class="font-pirate" style="color: var(--gold); font-size: 1.75rem;">‚öΩ Survivor Football</h1>
      <p class="sub">–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç—á—ñ —Ç–∞ —á–µ–∫–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</p>
    </header>

    <div id="loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
    <div id="error" class="error" style="display:none;"></div>

    <div id="admin" class="admin-only">
      <section class="section">
        <h2 class="section-title">üèÜ –ù–æ–≤–∞ –≥—Ä–∞</h2>
        <div class="card">
          <input type="text" id="newGameTitle" placeholder="–ù–∞–∑–≤–∞ –≥—Ä–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ü—Ä–µ–º'—î—Ä-–ª—ñ–≥–∞)" />
          <button type="button" id="btnCreateGame" class="btn btn-primary">–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">üéÆ –í–∞—à—ñ —ñ–≥—Ä–∏</h2>
        <div id="gamesList"></div>
      </section>

      <section class="section">
        <h2 class="section-title">‚öΩ –ó–∞–¥–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 10 —Ç—É—Ä—ñ–≤</h2>
        <div class="card">
          <div class="form-row">
            <label class="field-label">1. –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É</label>
            <select id="setTeamsGameId"><option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option></select>
          </div>
          <div class="form-row">
            <label class="field-label">2. –°–ø–∏—Å–æ–∫ 20 –∫–æ–º–∞–Ω–¥ (–ø–æ –æ–¥–Ω—ñ–π –Ω–∞ —Ä—è–¥–æ–∫)</label>
            <textarea id="setTeamsText" rows="12" placeholder="–í—É–ª–≤–µ—Ä—Ö—ç–º–ø—Ç–æ–Ω&#10;–ê—Ä—Å–µ–Ω–∞–ª&#10;–ë–æ—Ä–Ω–º—É—Ç&#10;–ú–∞–Ω –Æ–Ω–∞–π—Ç–µ–¥&#10;–ë—Ä–∞–π—Ç–æ–Ω&#10;–õ–∏–≤–µ—Ä–ø—É–ª—å&#10;–§—É–ª—Ö—ç–º&#10;–ë–µ—Ä–Ω–ª–∏&#10;–ú–∞–Ω –°–∏—Ç–∏&#10;–ö—Ä–∏—Å—Ç–∞–ª –ü—ç–ª–∞—Å&#10;–≠–≤–µ—Ä—Ç–æ–Ω&#10;–ß–µ–ª—Å–∏&#10;–õ–∏–¥—Å&#10;–ë—Ä–µ–Ω—Ç—Ñ–æ—Ä–¥&#10;–ù—å—é–∫–∞—Å–ª&#10;–°–∞–Ω–¥–µ—Ä–ª–µ–Ω–¥&#10;–ê—Å—Ç–æ–Ω –í–∏–ª–ª–∞&#10;–í–µ—Å—Ç –•—ç–º&#10;–¢–æ—Ç—Ç–µ–Ω—Ö—ç–º&#10;–ù–æ—Ç—Ç–∏–Ω–≥–µ–º –§–æ—Ä–µ—Å—Ç"></textarea>
          </div>
          <p class="hint">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä—É—î 10 —Ç—É—Ä—ñ–≤ –ø–æ 10 –º–∞—Ç—á—ñ–≤ (–ø–∞—Ä–∏ —Ç–∞—Å—É—é—Ç—å—Å—è –∫–æ–∂–µ–Ω —Ç—É—Ä). –°—Ç–∞—Ä—ñ –º–∞—Ç—á—ñ –≥—Ä–∏ –±—É–¥—É—Ç—å –∑–∞–º—ñ–Ω–µ–Ω—ñ.</p>
          <p id="setTeamsError" class="hint error-inline" style="display:none;"></p>
          <button type="button" id="btnSetTeams" class="btn btn-success">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ 10 —Ç—É—Ä—ñ–≤</button>
          <div id="setTeamsPreview" class="matches-preview" style="display:none;"></div>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">üìã –î–æ–¥–∞—Ç–∏ –º–∞—Ç—á—ñ –≤—Ä—É—á–Ω—É (–æ–¥–∏–Ω —Ä–∞—É–Ω–¥)</h2>
        <div class="card">
          <div class="form-row">
            <label class="field-label">–ì—Ä–∞</label>
            <select id="addMatchGameId"><option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option></select>
          </div>
          <div class="form-row">
            <label class="field-label">–ù–æ–º–µ—Ä —Ä–∞—É–Ω–¥—É</label>
            <input type="number" id="addMatchRound" placeholder="–ù–æ–º–µ—Ä —Ä–∞—É–Ω–¥—É" min="1" value="1" />
          </div>
          <div class="form-row">
            <label class="field-label">–ú–∞—Ç—á—ñ (–æ–¥–∏–Ω –Ω–∞ —Ä—è–¥–æ–∫: –î—ñ–º ‚Äî –ì–æ—Å—Ç—å)</label>
            <textarea id="addMatchText" rows="6" placeholder="–í—É–ª–≤–µ—Ä–≥–µ–º–ø—Ç–æ–Ω ‚Äî –ê—Ä—Å–µ–Ω–∞–ª&#10;–ë–æ—Ä–Ω–º—É—Ç ‚Äî –ú–∞–Ω –Æ–Ω–∞–π—Ç–µ–¥&#10;..."></textarea>
          </div>
          <p id="addMatchError" class="hint error-inline" style="display:none;"></p>
          <button type="button" id="btnAddMatches" class="btn btn-secondary">–î–æ–¥–∞—Ç–∏ –º–∞—Ç—á—ñ</button>
          <div id="matchesAddedPreview" class="matches-preview" style="display:none;"></div>
        </div>
      </section>
    </div>

    <div id="user" class="user-only">
      <nav class="tabs-wrap" aria-label="–†–æ–∑–¥—ñ–ª–∏">
        <button type="button" class="tab-btn active" data-tab="bets" id="tabBets">‚öΩ –°—Ç–∞–≤–∫–∏</button>
        <button type="button" class="tab-btn" data-tab="profile" id="tabProfile">üè¥‚Äç‚ò†Ô∏è –ü—Ä–æ—Ñ—ñ–ª—å</button>
      </nav>
      <div id="panelBets" class="tab-panel active">
        <section class="section" id="joinSection">
          <h2 class="section-title">üéØ –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –≥—Ä–∏</h2>
          <p class="balance-line" id="balanceLine">–í–∞—à –±–∞–ª–∞–Ω—Å: <strong id="balanceValue">‚Äî</strong> –ø–æ—ñ–Ω—Ç—ñ–≤</p>
          <div class="card" id="joinCard">
            <div class="form-row">
              <label class="field-label">–ì—Ä–∞</label>
              <select id="joinGameId"><option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option></select>
            </div>
            <div class="form-row">
              <label class="field-label">–°—É–º–∞ —Å—Ç–∞–≤–∫–∏ (–ø–æ—ñ–Ω—Ç—ñ–≤)</label>
              <select id="joinStake">
                <option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å —Å—Ç–∞–≤–∫—É ‚Äî</option>
              </select>
            </div>
            <button type="button" id="btnJoin" class="btn btn-primary">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
          </div>
        </section>
        <section class="section">
          <h2 class="section-title">üìã –ú–æ—ó –∑–∞–ø–∏—Å–∏</h2>
          <div id="entriesList"></div>
          <p class="hint">–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É –≤–∏—â–µ, —Å—É–º—É —Å—Ç–∞–≤–∫–∏ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è¬ª.</p>
        </section>
      </div>
      <div id="panelProfile" class="tab-panel">
        <section class="section">
          <h2 class="section-title">üí∞ –ë–∞–ª–∞–Ω—Å</h2>
          <div class="profile-balance-card">
            <div class="profile-balance-label">–í–∞—à —Å–∫–∞—Ä–±</div>
            <div class="profile-balance-value" id="profileBalanceValue">‚Äî <span>–ø–æ—ñ–Ω—Ç—ñ–≤</span></div>
          </div>
          <div class="profile-actions">
            <button type="button" class="btn btn-success" id="btnAddBalance" disabled title="–°–∫–æ—Ä–æ">–î–æ–¥–∞—Ç–∏ –±–∞–ª–∞–Ω—Å <span class="soon">(—Å–∫–æ—Ä–æ)</span></button>
            <button type="button" class="btn btn-secondary" id="btnWithdraw" disabled title="–°–∫–æ—Ä–æ">–í–∏–≤–µ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å <span class="soon">(—Å–∫–æ—Ä–æ)</span></button>
          </div>
        </section>
        <section class="section">
          <h2 class="section-title">üìú –Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞–≤–æ–∫</h2>
          <div id="profileHistory"></div>
        </section>
      </div>
    </div>
  </div>

  <script>
(function () {
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const baseUrl = window.location.origin;
  let initData = (tg && tg.initData) ? tg.initData : '';

  function qs() { return 'init_data=' + encodeURIComponent(initData); }
  function authHeaders(extra = {}) {
    const h = { ...extra };
    if (initData) h['X-Telegram-Init-Data'] = initData;
    return h;
  }

  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
    loadingEl.style.display = 'none';
  }

  function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(function (btn) {
      btn.classList.toggle('active', btn.dataset.tab === tabName);
    });
    document.getElementById('panelBets').classList.toggle('active', tabName === 'bets');
    document.getElementById('panelProfile').classList.toggle('active', tabName === 'profile');
  }

  function renderProfileHistory(entries) {
    const el = document.getElementById('profileHistory');
    if (!el) return;
    if (!entries || !entries.length) {
      el.innerHTML = '<p class="hint">–Ü—Å—Ç–æ—Ä—ñ—è —Å—Ç–∞–≤–æ–∫ –∑\'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç –ø—ñ—Å–ª—è —É—á–∞—Å—Ç—ñ –≤ —ñ–≥—Ä–∞—Ö.</p>';
      return;
    }
    el.innerHTML = entries.map(function (e) {
      let resultClass = 'active';
      let resultText = '–í –≥—Ä—ñ';
      if (e.status === 'cashed_out') {
        resultClass = 'win';
        resultText = '+ ' + (e.stake != null ? (Number(e.stake) % 1 === 0 ? e.stake : Number(e.stake).toFixed(1)) : '‚Äî') + ' –ø–æ—ñ–Ω—Ç—ñ–≤';
      } else if (e.status === 'out') {
        resultClass = 'loss';
        resultText = '–í–∏–±—É–≤';
      }
      const stakeStr = e.stake != null ? ' –°—Ç–∞–≤–∫–∞: ' + (Number(e.stake) % 1 === 0 ? e.stake : Number(e.stake).toFixed(1)) + ' –ø.' : '';
      return '<div class="history-item ' + resultClass + '">' +
        '<div><div class="history-game">' + escapeHtml(e.game_title) + '</div>' +
        '<div class="history-meta">–†–∞—É–Ω–¥ ' + e.current_round + ' / ' + e.rounds_total + stakeStr + '</div></div>' +
        '<span class="history-result ' + resultClass + '">' + escapeHtml(resultText) + '</span>' +
      '</div>';
    }).join('');
  }

  function showContent(me) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'none';
    document.body.classList.add(me.is_admin ? 'admin' : 'user');

    if (me.is_admin) {
      fillGamesSelects(me.games || []);
      renderGamesList(me.games || []);
      document.getElementById('btnCreateGame').onclick = createGame;
      document.getElementById('btnSetTeams').onclick = setTeams;
      document.getElementById('btnAddMatches').onclick = addMatches;
    } else {
      const balance = me.balance != null ? Number(me.balance) : 1000;
      document.getElementById('balanceValue').textContent = balance;
      var pv = document.getElementById('profileBalanceValue');
      if (pv) { pv.innerHTML = balance + ' <span>–ø–æ—ñ–Ω—Ç—ñ–≤</span>'; }
      fillStakeSelect(balance);
      fillJoinGameSelect(me.games || []);
      document.getElementById('btnJoin').onclick = joinGame;
      renderEntriesList(me.entries || [], me.games || []);
      renderProfileHistory(me.entries || []);
      document.getElementById('tabBets').onclick = function () { switchTab('bets'); };
      document.getElementById('tabProfile').onclick = function () { switchTab('profile'); };
    }
  }

  const STAKE_OPTIONS = [10, 20, 50, 100, 200];

  function fillStakeSelect(balance) {
    const sel = document.getElementById('joinStake');
    if (!sel) return;
    let opts = '<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å —Å—Ç–∞–≤–∫—É ‚Äî</option>';
    STAKE_OPTIONS.forEach(function (v) {
      if (v <= balance) opts += '<option value="' + v + '">' + v + ' –ø–æ—ñ–Ω—Ç—ñ–≤</option>';
    });
    sel.innerHTML = opts;
    if (balance < 10) {
      opts += '<option value="" disabled>–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø–æ—ñ–Ω—Ç—ñ–≤ (–º—ñ–Ω. 10)</option>';
      sel.innerHTML = opts;
    }
  }

  function fillJoinGameSelect(games) {
    const sel = document.getElementById('joinGameId');
    if (!sel) return;
    const opts = games.map(g => '<option value="' + g.id + '">' + escapeHtml(g.title) + ' ¬∑ —Ä–∞—É–Ω–¥ ' + g.current_round + '</option>').join('');
    sel.innerHTML = '<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option>' + opts;
  }

  function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function fillGamesSelects(games) {
    const opts = games.map(g => '<option value="' + g.id + '">' + escapeHtml(g.title) + ' ¬∑ —Ä–∞—É–Ω–¥ ' + g.current_round + '</option>').join('');
    document.getElementById('setTeamsGameId').innerHTML = '<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option>' + opts;
    document.getElementById('addMatchGameId').innerHTML = '<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option>' + opts;
    if (games.length === 1) {
      document.getElementById('setTeamsGameId').value = games[0].id;
      document.getElementById('addMatchGameId').value = games[0].id;
    }
  }

  function renderGamesList(games) {
    const el = document.getElementById('gamesList');
    if (!games.length) {
      el.innerHTML = '<div class="card game-card-admin"><span class="meta">–Ü–≥–æ—Ä –ø–æ–∫–∏ –Ω–µ–º–∞—î. –°—Ç–≤–æ—Ä—ñ—Ç—å –≥—Ä—É –≤–∏—â–µ.</span></div>';
      fillGamesSelects(games);
      return;
    }
    el.innerHTML = games.map(g =>
      '<div class="card game-card-admin">' +
        '<div class="name">' + escapeHtml(g.title) + '</div>' +
        '<div class="meta">–†–∞—É–Ω–¥ ' + g.current_round + ' –∑ ' + g.rounds_total + ' ¬∑ ' + g.status + '</div>' +
      '</div>'
    ).join('');
    fillGamesSelects(games);
  }

  function renderEntriesList(entries, games) {
    const webAppUrl = baseUrl + '/select_teams';
    const el = document.getElementById('entriesList');
    if (!entries.length) {
      el.innerHTML = '<p class="hint">–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É –≤–∏—â–µ, —Å—É–º—É —Å—Ç–∞–≤–∫–∏ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è¬ª.</p>';
      return;
    }
    el.innerHTML = entries.map(e => {
      const canPick = e.status === 'active';
      const link = canPick ? (webAppUrl + '?entry_id=' + e.entry_id) : '#';
      const cardClass = 'entry-card' + (canPick ? '' : ' disabled');
      let ctaText = '–ß–µ–∫–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤';
      if (canPick) ctaText = '–û–±—Ä–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏';
      else if (e.status === 'cashed_out') ctaText = '–í–∏–≥—Ä–∞—à –∑–∞–±—Ä–∞–Ω–æ';
      else if (e.status === 'out') ctaText = '–í–∏ –≤–∏–±—É–ª–∏';
      const ctaIcon = canPick ? '‚öΩ' : (e.status === 'cashed_out' ? 'üèÜ' : '‚è≥');
      const stakeStr = e.stake != null ? ' ¬∑ ' + (Number(e.stake) % 1 === 0 ? e.stake : Number(e.stake).toFixed(1)) + ' –≥—Ä–Ω' : '';
      return '<a href="' + link + '" class="' + cardClass + '">' +
        '<div class="game-name">' + escapeHtml(e.game_title) + '</div>' +
        '<div class="meta">–†–∞—É–Ω–¥ ' + e.current_round + ' –∑ ' + e.rounds_total + stakeStr + '</div>' +
        '<span class="cta">' + ctaIcon + ' ' + ctaText + '</span>' +
      '</a>';
    }).join('');
  }

  async function joinGame() {
    const gameId = document.getElementById('joinGameId').value;
    const stakeEl = document.getElementById('joinStake');
    const stakeVal = stakeEl && stakeEl.value ? parseInt(stakeEl.value, 10) : null;
    if (!gameId) {
      if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É');
      return;
    }
    if (!stakeVal || stakeVal < 10) {
      if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å —Å—É–º—É —Å—Ç–∞–≤–∫–∏ (–º—ñ–Ω. 10 –ø–æ—ñ–Ω—Ç—ñ–≤)');
      return;
    }
    try {
      const r = await fetch(baseUrl + '/api/join_game', {
        method: 'POST',
        headers: authHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify({ game_id: parseInt(gameId, 10), stake: stakeVal })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || '–ü–æ–º–∏–ª–∫–∞');
      if (tg) tg.showAlert('–í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å –¥–æ –≥—Ä–∏.');
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function createGame() {
    const title = document.getElementById('newGameTitle').value.trim();
    if (!title) { if (tg) tg.showAlert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≥—Ä–∏'); return; }
    try {
      const r = await fetch(baseUrl + '/api/games', { method: 'POST', headers: authHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify({ title }) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || '–ü–æ–º–∏–ª–∫–∞');
      if (tg) tg.showAlert('–ì—Ä—É —Å—Ç–≤–æ—Ä–µ–Ω–æ: ' + data.title);
      document.getElementById('newGameTitle').value = '';
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function setTeams() {
    const errEl = document.getElementById('setTeamsError');
    const previewEl = document.getElementById('setTeamsPreview');
    errEl.style.display = 'none';
    errEl.textContent = '';
    previewEl.style.display = 'none';
    const gameId = document.getElementById('setTeamsGameId').value;
    const text = document.getElementById('setTeamsText').value;
    if (!gameId) {
      errEl.textContent = '–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É –∑—ñ —Å–ø–∏—Å–∫—É –≤–∏—â–µ.';
      errEl.style.display = 'block';
      if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É');
      return;
    }
    const team_names = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (team_names.length !== 20) {
      errEl.textContent = '–ü–æ—Ç—Ä—ñ–±–Ω–æ —Ä—ñ–≤–Ω–æ 20 –∫–æ–º–∞–Ω–¥ (–ø–æ –æ–¥–Ω—ñ–π –Ω–∞ —Ä—è–¥–æ–∫). –ó–∞—Ä–∞–∑: ' + team_names.length;
      errEl.style.display = 'block';
      if (tg) tg.showAlert('–í–≤–µ–¥—ñ—Ç—å —Ä—ñ–≤–Ω–æ 20 –Ω–∞–∑–≤ –∫–æ–º–∞–Ω–¥');
      return;
    }
    try {
      const r = await fetch(baseUrl + '/api/games/' + gameId + '/set_teams', {
        method: 'POST',
        headers: authHeaders({ 'Content-Type': 'application/json' }),
        body: JSON.stringify({ team_names })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(typeof data.detail === 'string' ? data.detail : '–ü–æ–º–∏–ª–∫–∞');
      if (tg) tg.showAlert('–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ 10 —Ç—É—Ä—ñ–≤ –ø–æ 10 –º–∞—Ç—á—ñ–≤. –°—Ç–∞—Ä—ñ –º–∞—Ç—á—ñ –≥—Ä–∏ –∑–∞–º—ñ–Ω–µ–Ω—ñ.');
      previewEl.style.display = 'block';
      previewEl.innerHTML = '<div class="preview-title">–ì–æ—Ç–æ–≤–æ: 10 —Ç—É—Ä—ñ–≤, —É –∫–æ–∂–Ω–æ–º—É –ø–æ 10 –º–∞—Ç—á—ñ–≤ (–ø–∞—Ä–∏ –∑–º—ñ—à–∞–Ω—ñ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ç—É—Ä—É).</div>';
      loadMe();
    } catch (e) {
      errEl.textContent = e.message;
      errEl.style.display = 'block';
      if (tg) tg.showAlert(e.message);
    }
  }

  async function addMatches() {
    const errEl = document.getElementById('addMatchError');
    errEl.style.display = 'none';
    errEl.textContent = '';
    const gameId = document.getElementById('addMatchGameId').value;
    const round = parseInt(document.getElementById('addMatchRound').value, 10);
    const text = document.getElementById('addMatchText').value;
    if (!gameId) {
      errEl.textContent = '–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É –∑—ñ —Å–ø–∏—Å–∫—É –≤–∏—â–µ.';
      errEl.style.display = 'block';
      if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É –∑—ñ —Å–ø–∏—Å–∫—É ¬´–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É¬ª');
      return;
    }
    if (!round || round < 1) {
      errEl.textContent = '–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Ä–∞—É–Ω–¥—É (1, 2, 3...).';
      errEl.style.display = 'block';
      return;
    }
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (!lines.length) {
      errEl.textContent = '–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –º–∞—Ç—á —É —Ñ–æ—Ä–º–∞—Ç—ñ: –î—ñ–º ‚Äî –ì–æ—Å—Ç—å (–æ–¥–∏–Ω –Ω–∞ —Ä—è–¥–æ–∫).';
      errEl.style.display = 'block';
      if (tg) tg.showAlert('–í–≤–µ–¥—ñ—Ç—å –º–∞—Ç—á—ñ –≤ —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ');
      return;
    }
    try {
      const r = await fetch(baseUrl + '/api/games/' + gameId + '/matches', { method: 'POST', headers: authHeaders({ 'Content-Type': 'application/json' }), body: JSON.stringify({ round, matches: lines }) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || '–ü–æ–º–∏–ª–∫–∞');
      const added = data.added || 0;
      const notFound = data.not_found || [];
      if (notFound.length > 0) {
        errEl.textContent = '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑—ñ (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è): ' + notFound.slice(0, 8).join(', ') + (notFound.length > 8 ? '‚Ä¶' : '');
        errEl.style.display = 'block';
      }
      if (added > 0) {
        if (tg) tg.showAlert('–î–æ–¥–∞–Ω–æ –º–∞—Ç—á—ñ–≤: ' + added + (notFound.length ? '. –ß–∞—Å—Ç–∏–Ω–∞ –Ω–µ –¥–æ–¥–∞–ª–∞—Å—å ‚Äî –¥–∏–≤—ñ—Ç—å—Å—è –ø—ñ–¥–∫–∞–∑–∫—É –ø—ñ–¥ –∫–Ω–æ–ø–∫–æ—é.' : ''));
        document.getElementById('addMatchText').value = '';
      } else if (notFound.length === 0) {
        if (tg) tg.showAlert('–ù—ñ—á–æ–≥–æ –Ω–µ –¥–æ–¥–∞–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ñ–æ—Ä–º–∞—Ç: –î—ñ–º ‚Äî –ì–æ—Å—Ç—å –Ω–∞ –∫–æ–∂–µ–Ω —Ä—è–¥–æ–∫.');
      }
      loadMe();
      if (added > 0) {
        const listR = await fetch(baseUrl + '/api/games/' + gameId + '/matches?round=' + round, { headers: authHeaders() });
        const listData = await listR.json().catch(() => []);
        const preview = document.getElementById('matchesAddedPreview');
        if (listR.ok && Array.isArray(listData) && listData.length > 0) {
          preview.style.display = 'block';
          preview.innerHTML = '<div class="preview-title">–ú–∞—Ç—á—ñ —Ü—å–æ–≥–æ —Ä–∞—É–Ω–¥—É (–≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≥—Ä–∞–≤—Ü—è–º):</div>' +
            listData.map(m => '<div class="match-line">' + escapeHtml(m.home) + ' ‚Äî ' + escapeHtml(m.away) + '</div>').join('');
        } else {
          preview.style.display = 'block';
          preview.innerHTML = '<div class="preview-title">–î–æ–¥–∞–Ω–æ ' + added + ' –º–∞—Ç—á—ñ–≤. –í–æ–Ω–∏ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è —É –≤–∏–±–æ—Ä—ñ –≥—Ä–∞–≤—Ü—ñ–≤.</div>';
        }
      }
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function loadMe() {
    if (!initData) {
      showError('–í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫ –∑ —á–∞—Ç—É –±–æ—Ç–∞ @PriceCalculatorNL_bot (–∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é –∞–±–æ /start), –∞ –Ω–µ –ø–æ –ø—Ä—è–º–æ–º—É –ø–æ—Å–∏–ª–∞–Ω–Ω—é –≤ –±—Ä–∞—É–∑–µ—Ä—ñ.');
      return;
    }
    try {
      const r = await fetch(baseUrl + '/api/me', { headers: authHeaders() });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        const msg = data.detail || '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó';
        showError(msg + '\n\n–í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫ —Å–∞–º–µ –∑ –±–æ—Ç–∞ @PriceCalculatorNL_bot. –Ø–∫—â–æ –≤–∏ –∑–∞–π—à–ª–∏ –∑ —ñ–Ω—à–æ–≥–æ –±–æ—Ç–∞ ‚Äî –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ.');
        return;
      }
      showContent(data);
    } catch (e) {
      showError('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: ' + e.message);
    }
  }

  loadMe();
  setTimeout(function () {
    var splash = document.getElementById('splash');
    var main = document.getElementById('mainContainer');
    if (splash) splash.classList.add('hide');
    if (main) main.style.opacity = '1';
  }, 2500);
})();
  </script>
</body>
</html>
