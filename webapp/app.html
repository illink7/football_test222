<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Survivor Football</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #1a1a2e;
      --tg-theme-text-color: #eee;
      --tg-theme-button-color: #0f3460;
      --tg-theme-button-text-color: #eee;
      --accent: #e94560;
      --success: #4ecca3;
      --card-bg: rgba(255,255,255,0.06);
      --card-border: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .container { max-width: 420px; margin: 0 auto; padding: 20px 16px; }
    .header {
      text-align: center;
      padding: 20px 0 24px;
      border-bottom: 1px solid var(--card-border);
    }
    .header h1 { font-size: 1.5rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .header .sub { font-size: 0.85rem; opacity: 0.7; margin-top: 6px; }
    .loading { padding: 40px 24px; text-align: center; font-size: 1rem; opacity: 0.9; }
    .error { background: rgba(233,69,96,0.15); color: #e94560; padding: 16px; border-radius: 12px; margin: 16px; text-align: center; }
    .section {
      margin: 24px 0;
    }
    .section-title {
      font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;
      opacity: 0.85; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .card:last-child { margin-bottom: 0; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 14px 18px;
      font-size: 1rem;
      font-weight: 500;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.05s;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
    .btn-success { background: var(--success); color: #1a1a2e; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    input, textarea, select {
      width: 100%;
      padding: 14px 16px;
      margin-bottom: 12px;
      font-size: 1rem;
      background: rgba(255,255,255,0.08);
      color: var(--tg-theme-text-color);
      border: 1px solid var(--card-border);
      border-radius: 12px;
    }
    input::placeholder, textarea::placeholder { opacity: 0.6; }
    select { cursor: pointer; }
    .form-row { margin-bottom: 12px; }
    .form-row:last-child { margin-bottom: 0; }
    .hint { font-size: 0.8rem; opacity: 0.7; margin-top: 6px; }
    .admin-only { display: none; }
    .user-only { display: none; }
    body.admin .admin-only { display: block; }
    body.user .user-only { display: block; }
    .entry-card {
      display: block;
      text-decoration: none;
      color: inherit;
      padding: 18px;
      border-radius: 14px;
      border: 1px solid var(--card-border);
      background: var(--card-bg);
      margin-bottom: 12px;
      transition: background 0.2s, border-color 0.2s;
    }
    .entry-card:active { background: rgba(255,255,255,0.1); }
    .entry-card .game-name { font-weight: 600; font-size: 1.05rem; margin-bottom: 6px; }
    .entry-card .meta { font-size: 0.85rem; opacity: 0.8; margin-bottom: 12px; }
    .entry-card .cta {
      display: inline-flex; align-items: center; gap: 8px;
      color: var(--success); font-weight: 500; font-size: 0.95rem;
    }
    .entry-card.disabled .cta { color: var(--tg-theme-text-color); opacity: 0.7; }
    .game-card-admin { padding: 14px 16px; }
    .game-card-admin .name { font-weight: 600; margin-bottom: 4px; }
    .game-card-admin .meta { font-size: 0.8rem; opacity: 0.75; }
    .matches-preview {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--card-border);
    }
    .matches-preview .preview-title { font-size: 0.8rem; opacity: 0.8; margin-bottom: 8px; }
    .match-line { font-size: 0.9rem; padding: 4px 0; opacity: 0.95; }
    .expand-toggle { font-size: 0.85rem; color: var(--accent); cursor: pointer; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>‚öΩ Survivor Football</h1>
      <p class="sub">–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç—á—ñ —Ç–∞ —á–µ–∫–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</p>
    </header>

    <div id="loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</div>
    <div id="error" class="error" style="display:none;"></div>

    <div id="admin" class="admin-only">
      <section class="section">
        <h2 class="section-title">üèÜ –ù–æ–≤–∞ –≥—Ä–∞</h2>
        <div class="card">
          <input type="text" id="newGameTitle" placeholder="–ù–∞–∑–≤–∞ –≥—Ä–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –ü—Ä–µ–º'—î—Ä-–ª—ñ–≥–∞)" />
          <button type="button" id="btnCreateGame" class="btn btn-primary">–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É</button>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">üéÆ –í–∞—à—ñ —ñ–≥—Ä–∏</h2>
        <div id="gamesList"></div>
      </section>

      <section class="section">
        <h2 class="section-title">‚öΩ –î–æ–¥–∞—Ç–∏ –º–∞—Ç—á—ñ —Ä–∞—É–Ω–¥—É</h2>
        <div class="card">
          <div class="form-row">
            <select id="addMatchGameId"><option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option></select>
          </div>
          <div class="form-row">
            <input type="number" id="addMatchRound" placeholder="–ù–æ–º–µ—Ä —Ä–∞—É–Ω–¥—É" min="1" value="1" />
          </div>
          <div class="form-row">
            <textarea id="addMatchText" rows="8" placeholder="–û–¥–∏–Ω –º–∞—Ç—á –Ω–∞ —Ä—è–¥–æ–∫ —É —Ñ–æ—Ä–º–∞—Ç—ñ: –î—ñ–º ‚Äî –ì–æ—Å—Ç—å&#10;&#10;–ü—Ä–∏–∫–ª–∞–¥:&#10;–í—É–ª–≤–µ—Ä–≥–µ–º–ø—Ç–æ–Ω ‚Äî –ê—Ä—Å–µ–Ω–∞–ª&#10;–ë–æ—Ä–Ω–º—É—Ç ‚Äî –ú–∞–Ω—á–µ—Å—Ç–µ—Ä –Æ–Ω–∞–π—Ç–µ–¥&#10;–ë—Ä–∞–π—Ç–æ–Ω ‚Äî –õ—ñ–≤–µ—Ä–ø—É–ª—å"></textarea>
          </div>
          <button type="button" id="btnAddMatches" class="btn btn-success">–î–æ–¥–∞—Ç–∏ –º–∞—Ç—á—ñ</button>
          <div id="matchesAddedPreview" class="matches-preview" style="display:none;"></div>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">üë§ –î–æ–¥–∞—Ç–∏ —É—á–∞—Å–Ω–∏–∫–∞ –≤ –≥—Ä—É</h2>
        <div class="card">
          <div class="form-row">
            <select id="addEntryGameId"><option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option></select>
          </div>
          <div class="form-row">
            <input type="number" id="addEntryUserId" placeholder="–ó–∞–ª–∏—à—Ç–µ –ø–æ—Ä–æ–∂–Ω—ñ–º ‚Äî –¥–æ–¥–∞—Å—Ç—å—Å—è –≤–∞–º (–∞–¥–º—ñ–Ω—É)" />
            <p class="hint">–©–æ–± –¥–æ–¥–∞—Ç–∏ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è ‚Äî –≤—ñ–Ω –º–∞—î –Ω–∞–ø–∏—Å–∞—Ç–∏ –±–æ—Ç—É /start; –ø–æ—Ç—ñ–º –≤–∏ –º–æ–∂–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –π–æ–≥–æ –∑–∞ —Ü–∏–º –ø–æ–ª–µ–º (ID). –ê–±–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–¥–∞–π—Ç–µ —Å–µ–±–µ —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –±–æ—Ç–∞.</p>
          </div>
          <button type="button" id="btnAddEntry" class="btn btn-secondary">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>
        </div>
      </section>
    </div>

    <div id="user" class="user-only">
      <section class="section">
        <h2 class="section-title">üìã –ú–æ—ó –∑–∞–ø–∏—Å–∏</h2>
        <div id="entriesList"></div>
        <p class="hint">–Ø–∫—â–æ –∑–∞–ø–∏—Å—ñ–≤ –Ω–µ–º–∞—î ‚Äî –∞–¥–º—ñ–Ω –¥–æ–¥–∞—Å—Ç—å –≤–∞—Å —É –≥—Ä—É. –ù–∞–ø–∏—à—ñ—Ç—å –±–æ—Ç—É /start —ñ –∑‚Äô—è–≤–∏—Ç—å—Å—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –¥–æ–¥–∞—Ç–∫—É.</p>
      </section>
    </div>
  </div>

  <script>
(function () {
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const baseUrl = window.location.origin;
  let initData = (tg && tg.initData) ? tg.initData : '';

  function qs() { return 'init_data=' + encodeURIComponent(initData); }

  const loadingEl = document.getElementById('loading');
  const errorEl = document.getElementById('error');

  function showError(msg) {
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
    loadingEl.style.display = 'none';
  }

  function showContent(me) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'none';
    document.body.classList.add(me.is_admin ? 'admin' : 'user');

    if (me.is_admin) {
      fillGamesSelects(me.games || []);
      renderGamesList(me.games || []);
      document.getElementById('btnCreateGame').onclick = createGame;
      document.getElementById('btnAddMatches').onclick = addMatches;
      document.getElementById('btnAddEntry').onclick = addEntry;
    } else {
      renderEntriesList(me.entries || []);
    }
  }

  function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function fillGamesSelects(games) {
    const opts = games.map(g => '<option value="' + g.id + '">' + escapeHtml(g.title) + ' ¬∑ —Ä–∞—É–Ω–¥ ' + g.current_round + '</option>').join('');
    document.getElementById('addMatchGameId').innerHTML = '<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option>' + opts;
    document.getElementById('addEntryGameId').innerHTML = '<option value="">‚Äî –æ–±–µ—Ä—ñ—Ç—å –≥—Ä—É ‚Äî</option>' + opts;
  }

  function renderGamesList(games) {
    const el = document.getElementById('gamesList');
    if (!games.length) {
      el.innerHTML = '<div class="card game-card-admin"><span class="meta">–Ü–≥–æ—Ä –ø–æ–∫–∏ –Ω–µ–º–∞—î. –°—Ç–≤–æ—Ä—ñ—Ç—å –≥—Ä—É –≤–∏—â–µ.</span></div>';
      fillGamesSelects(games);
      return;
    }
    el.innerHTML = games.map(g =>
      '<div class="card game-card-admin">' +
        '<div class="name">' + escapeHtml(g.title) + '</div>' +
        '<div class="meta">–†–∞—É–Ω–¥ ' + g.current_round + ' –∑ ' + g.rounds_total + ' ¬∑ ' + g.status + '</div>' +
      '</div>'
    ).join('');
    fillGamesSelects(games);
  }

  function renderEntriesList(entries) {
    const webAppUrl = baseUrl + '/select_teams';
    const el = document.getElementById('entriesList');
    if (!entries.length) {
      el.innerHTML = '<p class="hint">–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤. –ê–¥–º—ñ–Ω –¥–æ–¥–∞—Å—Ç—å –≤–∞—Å —É –≥—Ä—É.</p>';
      return;
    }
    el.innerHTML = entries.map(e => {
      const canPick = e.status === 'active';
      const link = canPick ? (webAppUrl + '?entry_id=' + e.entry_id) : '#';
      const cardClass = 'entry-card' + (canPick ? '' : ' disabled');
      const ctaText = canPick ? '–û–±—Ä–∞—Ç–∏ –º–∞—Ç—á—ñ' : '–ß–µ–∫–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤';
      const ctaIcon = canPick ? '‚öΩ' : '‚è≥';
      return '<a href="' + link + '" class="' + cardClass + '">' +
        '<div class="game-name">' + escapeHtml(e.game_title) + '</div>' +
        '<div class="meta">–†–∞—É–Ω–¥ ' + e.current_round + ' –∑ ' + e.rounds_total + '</div>' +
        '<span class="cta">' + ctaIcon + ' ' + ctaText + '</span>' +
      '</a>';
    }).join('');
  }

  async function createGame() {
    const title = document.getElementById('newGameTitle').value.trim();
    if (!title) { if (tg) tg.showAlert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≥—Ä–∏'); return; }
    try {
      const r = await fetch(baseUrl + '/api/games?' + qs(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title }) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || '–ü–æ–º–∏–ª–∫–∞');
      if (tg) tg.showAlert('–ì—Ä—É —Å—Ç–≤–æ—Ä–µ–Ω–æ: ' + data.title);
      document.getElementById('newGameTitle').value = '';
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function addMatches() {
    const gameId = document.getElementById('addMatchGameId').value;
    const round = parseInt(document.getElementById('addMatchRound').value, 10);
    const text = document.getElementById('addMatchText').value;
    if (!gameId || !round) { if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É —Ç–∞ –≤–∫–∞–∂—ñ—Ç—å —Ä–∞—É–Ω–¥'); return; }
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    if (!lines.length) { if (tg) tg.showAlert('–í–≤–µ–¥—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –º–∞—Ç—á (—Ä—è–¥–æ–∫: –î—ñ–º ‚Äî –ì–æ—Å—Ç—å)'); return; }
    try {
      const r = await fetch(baseUrl + '/api/games/' + gameId + '/matches?' + qs(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ round, matches: lines }) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || '–ü–æ–º–∏–ª–∫–∞');
      const added = data.added || 0;
      if (tg) tg.showAlert('–î–æ–¥–∞–Ω–æ –º–∞—Ç—á—ñ–≤: ' + added);
      document.getElementById('addMatchText').value = '';
      loadMe();
      if (added > 0) {
        const listR = await fetch(baseUrl + '/api/games/' + gameId + '/matches?round=' + round + '&' + qs());
        const listData = await listR.json().catch(() => []);
        const preview = document.getElementById('matchesAddedPreview');
        if (listR.ok && Array.isArray(listData) && listData.length > 0) {
          preview.style.display = 'block';
          preview.innerHTML = '<div class="preview-title">–ú–∞—Ç—á—ñ —Ü—å–æ–≥–æ —Ä–∞—É–Ω–¥—É (–≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≥—Ä–∞–≤—Ü—è–º):</div>' +
            listData.map(m => '<div class="match-line">' + escapeHtml(m.home) + ' ‚Äî ' + escapeHtml(m.away) + '</div>').join('');
        } else {
          preview.style.display = 'block';
          preview.innerHTML = '<div class="preview-title">–î–æ–¥–∞–Ω–æ ' + added + ' –º–∞—Ç—á—ñ–≤. –í–æ–Ω–∏ –∑‚Äô—è–≤–ª—è—Ç—å—Å—è —É –≤–∏–±–æ—Ä—ñ –≥—Ä–∞–≤—Ü—ñ–≤.</div>';
        }
      }
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function addEntry() {
    const gameId = document.getElementById('addEntryGameId').value;
    const userIdInput = document.getElementById('addEntryUserId').value.trim();
    if (!gameId) { if (tg) tg.showAlert('–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É'); return; }
    const body = { game_id: parseInt(gameId, 10) };
    if (userIdInput) body.user_id = parseInt(userIdInput, 10);
    try {
      const r = await fetch(baseUrl + '/api/entries?' + qs(), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const data = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(data.detail || '–ü–æ–º–∏–ª–∫–∞');
      if (tg) tg.showAlert('–ó–∞–ø–∏—Å –¥–æ–¥–∞–Ω–æ. –ì—Ä–∞–≤–µ—Ü—å –∑–º–æ–∂–µ –æ–±—Ä–∞—Ç–∏ –º–∞—Ç—á—ñ —É —Å–≤–æ—î–º—É –¥–æ–¥–∞—Ç–∫—É.');
      document.getElementById('addEntryUserId').value = '';
      loadMe();
    } catch (e) {
      if (tg) tg.showAlert(e.message);
    }
  }

  async function loadMe() {
    if (!initData) {
      showError('–í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–æ–¥–∞—Ç–æ–∫ –∑ Telegram (–∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é –±–æ—Ç–∞ –∞–±–æ /start).');
      return;
    }
    try {
      const r = await fetch(baseUrl + '/api/me?' + qs());
      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        showError(data.detail || '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó');
        return;
      }
      showContent(data);
    } catch (e) {
      showError('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: ' + e.message);
    }
  }

  loadMe();
})();
  </script>
</body>
</html>
